<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="一只特立独行的鸟">
<meta property="og:type" content="website">
<meta property="og:title" content="一只特立独行的鸟">
<meta property="og:url" content="http://kuring.me/page/3/index.html">
<meta property="og:site_name" content="一只特立独行的鸟">
<meta property="og:description" content="一只特立独行的鸟">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一只特立独行的鸟">
<meta name="twitter:description" content="一只特立独行的鸟">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://kuring.me/page/3/"/>





  <title> 一只特立独行的鸟 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一只特立独行的鸟</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">分享我的学习心得，记录我的学习笔记。趁着年轻多学点东西总是正确的~~~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/aleap_idx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/aleap_idx/" itemprop="url">
                  asleap中的简单文件索引机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-02-28T00:00:00+08:00">
                2015-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>asleap是一个开源的vpn破解工具，最近查看了asleap的源码，该项目<a href="http://sourceforge.net/projects/asleap/" target="_blank" rel="external">地址</a>。本文的重点是对其中的带索引的字典文件的产生过程进行介绍，产生带索引的字典文件并不复杂，但是要想用简洁易懂的语言将该问题描述明白却不容易。</p>
<p>asleap破解vpn的机制是通过字典文件暴力破解的方式，该字典文件有dat数据文件和idx索引文件两个文件组成，两个文件均为二进制格式。asleap工程中自带了genkey程序，可以将文本的字典文件转换为asleap程序需要的带索引的字典文件。</p>
<p>本文以字典文件为以下内容讲解：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">turquoise</div><div class="line">da</div><div class="line">test</div></pre></td></tr></table></figure>
<h1 id="读取字典文件并产生md4值"><a href="#读取字典文件并产生md4值" class="headerlink" title="读取字典文件并产生md4值"></a>读取字典文件并产生md4值</h1><p>md4编码占16个字节，三个字典进行md4编码后的结果分别为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">18 07 33 43 f6 30 b5 f8 2c 38 c0 34 37 f2 81 6b</div><div class="line">01 19 a3 80 94 40 60 3c 57 39 5e 73 f3 60 95 98</div><div class="line">0c b6 94 88 05 f7 97 bf 2a 82 80 79 73 b8 95 37</div></pre></td></tr></table></figure>
<h1 id="将字典信息写入到临时文件"><a href="#将字典信息写入到临时文件" class="headerlink" title="将字典信息写入到临时文件"></a>将字典信息写入到临时文件</h1><p>为了能够对最终生成的dat文件中的内容进行排序和便于索引，程序生成了256个临时文件，文件名格式为从genk-bucket-00.tmp到genk-bucket-ff.tmp。程序根据md4编码中的第14位将字典对应的信息分别写入到临时文件中，一个字典写入到临时文件的内容如下，如果一个临时文件中存在多个字典则依次存放：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> hashpass_rec &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> rec_size;		<span class="comment">// 一个字典占用文件的大小，包括该变量+字典+字典对应的md4值共占用的字节数</span></div><div class="line">    <span class="keyword">char</span>          *password;	<span class="comment">// 字典</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> hash[<span class="number">16</span>];		<span class="comment">// 字典对应的md4值</span></div><div class="line">&#125; __attribute__ ((packed));</div></pre></td></tr></table></figure>
<p>本例子中turquoise对应结构体会写入到genk-bucket-81.tmp中，da和test对应结构体会依次写入到genk-bucket-95.tmp中。</p>
<h1 id="读取临时文件并写入到dat数据文件中"><a href="#读取临时文件并写入到dat数据文件中" class="headerlink" title="读取临时文件并写入到dat数据文件中"></a>读取临时文件并写入到dat数据文件中</h1><p>最终dat文件中的数据内容为hashpass_rec的有序集合，排序的原则是按照md4的第14和15两个字节。依次读取256个临时文件中的hashpass_rec可以保证dat文件中的数据内容是按照第14字节排序的，但是不能够保证是按照第15个字节排序的。为了保证最终dat文件中的数据内容是按照第14和15字节有序的，在将一个临时文件中的内容写入到dat文件中前需要对该临时文件中的hashpass_rec结果按照hash变量的第15字节进行排序，直接使用C语言中的qsort进行排序。</p>
<p>该例子中da和test位于同一个临时文件中，需要根据hash变量的第15字节排序的结果为test、da，最终写入到dat文件中的排序结果为turquoise、test、da。</p>
<h1 id="根据dat数据文件产生idx索引文件"><a href="#根据dat数据文件产生idx索引文件" class="headerlink" title="根据dat数据文件产生idx索引文件"></a>根据dat数据文件产生idx索引文件</h1><p>idx索引文件中存放的是多个hashpassidx_rec结果，最多有256*256项，其结构定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> hashpassidx_rec &#123;</div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>	        hashkey[<span class="number">2</span>];	<span class="comment">// 对应md4编码的第14和15字节</span></div><div class="line">    <span class="keyword">off_t</span>                   offset;		<span class="comment">// 第一个匹配的hashpass_rec结构在dat文件中的偏移，占用4个字节</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> <span class="keyword">int</span> 	numrec;		<span class="comment">// dat文件中共有多少个匹配的hashpass_rec结果</span></div><div class="line">&#125; __attribute__ ((packed));	<span class="comment">// 字节对齐，需要填充4个字节</span></div></pre></td></tr></table></figure>
<p>最终完成的dat文件和idx文件的指向如下图所示：</p>
<p><img src="http://kuring.qiniudn.com/aleap_idx.png" alt="最终完成的dat文件和idx文件的指向"></p>
<h1 id="bug"><a href="#bug" class="headerlink" title="bug"></a>bug</h1><p>genkeys.c文件中在读取字典文件时存在bug，在文件的207行将内容更改为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (!feof(inputfl)) &#123;</div><div class="line">		<span class="built_in">memset</span>(password, <span class="number">0</span>, MAX_NT_PASSWORD + <span class="number">1</span>);</div><div class="line">        fgets(password, MAX_NT_PASSWORD+<span class="number">1</span>, inputfl);</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(password) == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125;</div></pre></td></tr></table></figure>
<h1 id="相关下载"><a href="#相关下载" class="headerlink" title="相关下载"></a>相关下载</h1><p><a href="http://pan.baidu.com/s/1jGmVF06" target="_blank" rel="external">字典文件等相关文件下载</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/algorithm_sort_code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/algorithm_sort_code/" itemprop="url">
                  常用排序算法整理及代码实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-02-25T00:00:00+08:00">
                2015-02-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文对我编写的常用的排序算法进行整理和总结，方便用时进行查阅和参考。</p>
<h1 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h1><p>快速排序是实际应用中的最好选择，采用了分治法的思想。通过一趟排序将待排序记录分割成独立的两部分，其中一部分的关键字均比另外一部分的小，分别对这两部分记录进行排序，已达到整个有序。</p>
<p>是否稳定：不稳定</p>
<p>时间复杂度：O(nlogn)</p>
<p>空间复杂度：O(logn)，需要栈来实现递归用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">partition</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> pivotkey = numbers[low];</div><div class="line">    <span class="keyword">while</span> (low &lt; high)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">while</span> (low &lt; high &amp;&amp; numbers[high] &gt;= pivotkey)</div><div class="line">        &#123;</div><div class="line">            --high;</div><div class="line">        &#125;</div><div class="line">        numbers[low] = numbers[high];</div><div class="line">        <span class="keyword">while</span> (low &lt; high &amp;&amp; numbers[low] &lt;= pivotkey)</div><div class="line">        &#123;</div><div class="line">            ++low;</div><div class="line">        &#125;</div><div class="line">        numbers[high] = numbers[low];</div><div class="line">        numbers[low] = pivotkey;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> low;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quick_sort</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (low &lt; high)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> pivotloc = partition(numbers, low, high);</div><div class="line">        quick_sort(numbers, low, pivotloc - <span class="number">1</span>);</div><div class="line">        quick_sort(numbers, pivotloc + <span class="number">1</span>, high);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">quick_sort</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers)</span></span></div><div class="line">&#123;</div><div class="line">    quick_sort(numbers, <span class="number">0</span>, numbers.size() - <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; numbers = &#123;<span class="number">49</span>, <span class="number">38</span>, <span class="number">65</span>, <span class="number">97</span>, <span class="number">76</span>, <span class="number">13</span>, <span class="number">27</span>, <span class="number">49</span>&#125;;</div><div class="line">    quick_sort(numbers);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numbers.size(); i++)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\t"</span>, numbers[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h1><p>将两个或两个以上的有序表组合成一个新的有序表。合并两个有序表的方法为：比较两个有序表中第一个数，谁小先取谁。继续进行比较，只要有一个有序表为空，直接将另一个有序表取出即可。</p>
<p>是否稳定：稳定</p>
<p>时间复杂度：O(nlogn)</p>
<p>空间复杂度：O(n) （当使用顺序存储时，为了能够实现两个有序表之间的合并），或O(1)（当使用链式存储的时候，不再需要临时的空间来存储排序的结果）</p>
<h2 id="顺序存储代码"><a href="#顺序存储代码" class="headerlink" title="顺序存储代码"></a>顺序存储代码</h2><p>以下为采用顺序存储结构的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 归并排序使用递归算法的效率比较低，具体应用中会采用非递归算法代替</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;extra, <span class="keyword">int</span> low, <span class="keyword">int</span> high, <span class="keyword">int</span> middle)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i = low, j = middle+<span class="number">1</span>, k = low;</div><div class="line">    <span class="keyword">for</span> (; i&lt;=middle &amp;&amp; j&lt;=high; k++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (numbers[i] &lt;= numbers[j])</div><div class="line">        &#123;</div><div class="line">            extra[k] = numbers[i];</div><div class="line">            i++;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            extra[k] = numbers[j];</div><div class="line">            j++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">while</span> (i &lt;= middle)</div><div class="line">    &#123;</div><div class="line">        extra[k++] = numbers[i++];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (j &lt;= middle)</div><div class="line">    &#123;</div><div class="line">        extra[k++] = numbers[j++];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> m = low; m &lt;= high; m++)</div><div class="line">    &#123;</div><div class="line">        numbers[m] = extra[m];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge_sort</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;extra, <span class="keyword">int</span> low, <span class="keyword">int</span> high)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (low == high)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> ;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> middle = (low + high) / <span class="number">2</span>;</div><div class="line">    merge_sort(numbers, extra, low, middle);</div><div class="line">    merge_sort(numbers, extra, middle + <span class="number">1</span>, high);</div><div class="line">    merge(numbers, extra, low, high, middle);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge_sort</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; &amp;numbers)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// 申请额外的存储空间来用于排序处理</span></div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; extra = numbers;</div><div class="line">    merge_sort(numbers, extra, <span class="number">0</span>, numbers.size() - <span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; numbers = &#123;<span class="number">49</span>, <span class="number">38</span>, <span class="number">65</span>, <span class="number">97</span>, <span class="number">76</span>, <span class="number">13</span>, <span class="number">27</span>, <span class="number">49</span>&#125;;</div><div class="line">    merge_sort(numbers);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numbers.size(); i++)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\t"</span>, numbers[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="链式存储代码"><a href="#链式存储代码" class="headerlink" title="链式存储代码"></a>链式存储代码</h2><p>以下为采用链式存储结构的代码，本答案为我在LeetCode上的<a href="https://leetcode.com/problems/sort-list/" target="_blank" rel="external">Sort List </a>题目的答案，源码放在<a href="https://github.com/kuring/leetcode/blob/master/src/sortList/sort_list.cpp" target="_blank" rel="external">我的Github上</a>。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> ListNode &#123;</div><div class="line">    <span class="keyword">int</span> val;</div><div class="line">    ListNode *next;</div><div class="line">    ListNode(<span class="keyword">int</span> x) : val(x), next(<span class="literal">NULL</span>) &#123;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 使用归并排序方法，核心思想为将数组拆分为两半，分别对两半进行排序，排序完成后再进行一次排序，排序算法就可以采用插入排序的方式。</div><div class="line"> * 对两半排序的算法仍然采用归并排序算法，即问题为递归问题</div><div class="line"> * 在使用线性存储结果的归并排序算法中，会使用额外的空间来存储临时结果，空间复杂度为O(n)，而在链式存储中，空间复杂度为O(1)</div><div class="line"> * 归并排序的时间复杂度为O(nlogn)</div><div class="line"> * 如果存储结构为双向链表，可以使用快速排序</div><div class="line"> */</div><div class="line"><span class="function">ListNode* <span class="title">sortList</span><span class="params">(ListNode* head)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (head == <span class="literal">nullptr</span> || head-&gt;next == <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> head;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (head-&gt;next-&gt;next == <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 仅有两个元素，对两个元素进行排序后直接返回</span></div><div class="line">        <span class="keyword">if</span> (head-&gt;val &lt; head-&gt;next-&gt;val)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> head;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            ListNode *tmp = head-&gt;next;</div><div class="line">            tmp-&gt;next = head;</div><div class="line">            tmp-&gt;next-&gt;next = <span class="literal">nullptr</span>;</div><div class="line">            <span class="keyword">return</span> tmp;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 为了找到中间节点，这里采用快慢指针的方式，否则需要使用先遍历一次取长度，然后找到中间位置的两次遍历方式</span></div><div class="line">    ListNode *fast = head;</div><div class="line">    ListNode *slow = head;</div><div class="line">    ListNode *slow_prev = <span class="literal">nullptr</span>;</div><div class="line">    <span class="keyword">while</span> (fast != <span class="literal">nullptr</span> &amp;&amp; fast-&gt;next != <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        fast = fast-&gt;next-&gt;next;</div><div class="line">        slow_prev = slow;</div><div class="line">        slow = slow-&gt;next;</div><div class="line">    &#125;</div><div class="line">    fast = slow_prev-&gt;next;</div><div class="line">    slow_prev-&gt;next = <span class="literal">nullptr</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 分别对两段链表进行排序</span></div><div class="line">    slow = sortList(head);</div><div class="line">    fast = sortList(fast);</div><div class="line"></div><div class="line">    <span class="comment">// 对两段链表进行合并</span></div><div class="line">    ListNode *node = <span class="literal">nullptr</span>, *result = <span class="literal">nullptr</span>;</div><div class="line">    <span class="keyword">while</span> (slow != <span class="literal">nullptr</span> &amp;&amp; fast != <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (slow-&gt;val &lt; fast-&gt;val)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (result != <span class="literal">nullptr</span>)</div><div class="line">            &#123;</div><div class="line">                node-&gt;next = slow;</div><div class="line">                node = node-&gt;next;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                node = slow;</div><div class="line">                result = slow;</div><div class="line">            &#125;</div><div class="line">            slow = slow-&gt;next;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (result != <span class="literal">nullptr</span>)</div><div class="line">            &#123;</div><div class="line">                node-&gt;next = fast;</div><div class="line">                node = node-&gt;next;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                node = fast;</div><div class="line">                result = fast;</div><div class="line">            &#125;</div><div class="line">            fast = fast-&gt;next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (slow != <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        node-&gt;next = slow;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fast != <span class="literal">nullptr</span>)</div><div class="line">    &#123;</div><div class="line">        node-&gt;next = fast;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="直接插入排序"><a href="#直接插入排序" class="headerlink" title="直接插入排序"></a>直接插入排序</h1><p>该排序算法的时间复杂度为O(n^2)，算法复杂度过高。分为顺序存储和链式存储两种算法，其中顺序存储每比较一个元素是从该元素往前比较的，而链式存储是从链头开始比较的，这点有所不同，造成不同的是由存储结构决定的。</p>
<h2 id="顺序存储代码-1"><a href="#顺序存储代码-1" class="headerlink" title="顺序存储代码"></a>顺序存储代码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;iostream&gt;</div><div class="line">#include &lt;algorithm&gt;</div><div class="line">#include &lt;vector&gt;</div><div class="line">using namespace std;</div><div class="line"></div><div class="line">void insertion_sort(std::vector&lt;int&gt; &amp;numbers)</div><div class="line">&#123;</div><div class="line">	if (numbers.size() &lt;= 1)</div><div class="line">	&#123;</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line">	for (int i = 1; i &lt; numbers.size(); i++)</div><div class="line">	&#123;</div><div class="line">		for (int j = i; j &gt; 0; j--)</div><div class="line">		&#123;</div><div class="line">			if (numbers[j] &lt; numbers[j - 1])</div><div class="line">			&#123;</div><div class="line">				swap(numbers[j], numbers[j - 1]);</div><div class="line">			&#125;</div><div class="line">			else</div><div class="line">			&#123;</div><div class="line">				break;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main()</div><div class="line">&#123;</div><div class="line">	int a[] = &#123; 49, 38, 65, 97, 76, 13, 27, 49 &#125;;</div><div class="line">	vector&lt;int&gt; numbers(a, a + sizeof(a) / sizeof(int));</div><div class="line">	insertion_sort(numbers);</div><div class="line">	for (int i = 0; i&lt;numbers.size(); i++)</div><div class="line">	&#123;</div><div class="line">		printf(&quot;%d\t&quot;, numbers[i]);</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="链式存储代码-1"><a href="#链式存储代码-1" class="headerlink" title="链式存储代码"></a>链式存储代码</h2><p>以下代码为LeetCode上的链式存储的情况时的直接插入排序算法的代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function">ListNode* <span class="title">insertionSortList</span><span class="params">(ListNode* head)</span> </span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (head == <span class="literal">NULL</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 初始化</span></div><div class="line">    ListNode *node = head-&gt;next;</div><div class="line">    ListNode *new_head = head;</div><div class="line">    new_head-&gt;next = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">while</span> (node != <span class="literal">NULL</span>)</div><div class="line">    &#123;</div><div class="line">        ListNode *node_next = node-&gt;next;   <span class="comment">// 先将当前遍历的下一个节点保存</span></div><div class="line">        </div><div class="line">        <span class="comment">// 将当前节点插入到新链表中</span></div><div class="line">        ListNode *new_node_tmp = new_head;</div><div class="line">        <span class="keyword">if</span> (node-&gt;val &lt; new_node_tmp-&gt;val)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 当前节点插入新链表的第一个位置</span></div><div class="line">            node-&gt;next = new_head;</div><div class="line">            new_head = node;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 将当前节点插入到中间</span></div><div class="line">            <span class="keyword">while</span> (new_node_tmp-&gt;next != <span class="literal">NULL</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (node-&gt;val &lt; new_node_tmp-&gt;next-&gt;val)</div><div class="line">                &#123;</div><div class="line">                    node-&gt;next = new_node_tmp-&gt;next;</div><div class="line">                    new_node_tmp-&gt;next = node;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                new_node_tmp = new_node_tmp-&gt;next;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// 将该节点插入到最后位置</span></div><div class="line">            <span class="keyword">if</span> (new_node_tmp-&gt;next == <span class="literal">NULL</span>)</div><div class="line">            &#123;</div><div class="line">                new_node_tmp-&gt;next = node;</div><div class="line">                node-&gt;next = <span class="literal">NULL</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">            </div><div class="line">        <span class="comment">// 开始遍历当前节点的下一个节点</span></div><div class="line">        node = node_next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> new_head;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/2014_summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/2014_summary/" itemprop="url">
                  2014年总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-02-13T00:00:00+08:00">
                2015-02-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我的年总结是依照农历的，因为在我心中春节才算是一年的真正开始，因为只有春节的时候才能找到年的滋味，年的感觉，才能称之为年，阳历的年只能称之为year。</p>
<p>2014年又在不经意间过去了，很多地方跟2013年一样是平淡，工作和学习仍然是生活的主旋律，闲暇时间抽个时间玩玩dota放松一下，周末偶尔爬个小山锻炼下身体，对我的人生中算是比较重要的一年。</p>
<h1 id="学习"><a href="#学习" class="headerlink" title="学习"></a>学习</h1><p>2014年经历了结婚、毕业答辩和考驾照几件占用时间的事情，留给我业余时间用来学习的就少之又少了。结婚占用两个月时间，毕业论文占用了我两个月时间，考驾照占用了多个周末，工作出差占用了我一个月时间，留给我能够独立学习的晚上也就6个月时间。</p>
<p>开始的时候小看了硕士论文，以为很简单一事情，搞过这么多软件项目还搞不了一篇硕士论文。一直以来我看不起软件工程类论文，就一项目套个模板一介绍就是一篇论文，于是我选择了写一篇理论研究类论文，没有高大上的理论，而是在公司实践中真正用到的，《将Windows平台的C/C++程序向Linux平台移植的技术研究》，选择论文的时候我已经看到了该题目不太适合作为硕士论文，当我还是毅然作为了我的硕士论文题目，不得不说这是我今年的一大败笔。第一篇论文失败后，我重新走起了保守路线，以之前熟悉的系统为主线，辅以各种文档的拼凑，完成了一篇我曾经嗤之以项目类硕士论文，并顺利通过答辩。对于我这样的新手而言，写论文是一件漫长又痛苦的过程，占用了我大量的宝贵时间。</p>
<p>一直以来对嵌入式linux方向比较好奇，今年终于抵不住好奇，买了个2140开发板自己捣鼓了一段时间，由于时间关系虽然到现在也没有入门，多多少少对嵌入式已经有所了解。</p>
<p>感谢我的另一半，给我提供了足够的时间来干我想干的事情。</p>
<h1 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h1><p>比起2013年，今年读过的书籍少了一些。</p>
<ul>
<li>《Linux/Unix系统编程手册》</li>
<li>《编程珠玑》</li>
<li>《LINUX设备驱动程序》（部分章节）</li>
<li>《LINUX内核设计与实现》（大部分章节）</li>
<li>《深度探索linux操作系统》</li>
<li>《剑指Office》</li>
<li>《大规模C++程序设计》</li>
<li>《程序员的自我修养》（第二遍）</li>
<li>《文明之光》</li>
<li>《程序员健康指南》</li>
<li>《黄金时代》</li>
<li>《一只特立独行的猪》</li>
<li>《算法导论》（部分章节）</li>
</ul>
<h1 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h1><p>已经比较熟练掌握了公司产品的大部分技术，工作起来算是得心应手，但是却少了许多挑战，是时候该接收大挑战的了。工作的职位从后台组长到研发部副经理到研发部经理，开始了工作的转型，这是我不期望这么早来到的，我自认为技术的成长空间还很大，不想过早的接触管理岗位。</p>
<p>五月份的出差成为了我心中抹不去的痛，莫名其妙接受了任务，匆忙出差，不过坑才刚刚开始。要维护的是一个我没见过界面的产品，不过基本原理我是清楚的。产品有很多bug，这我可以理解，要不然也不会让我出差了，但要命的是我没有产品的代码，我接受的任务仅是去应付客户、发现bug后反馈、更新产品、施工，这明白着是市场+测试+维护的话，跟我半毛钱关系都没有。以上这些都无所谓，要知道我可不是一个顽固不化的程序员，但工作地点竟然是机房，而且机房是我见过最脏最乱的机房，我就站在一排机柜的后面的一堆烂纸箱子上吹着空调的冷风和机器的热风办公，时而蹲着，时而站着，时而坐着，时而将衣领撩起保暖，时而浑身打颤，以至于到现在我留下了膝盖隐隐作痛的毛病。而且系统bug不断，一连在不吃晚饭的情况下加班到大半夜好多次，而我竟然坚持下来了。原本三五天的出差计划，一待就是二十多天。这短短的二十多天成为了我今年最难忘的痛，多少次期望回到家里温暖的被窝，多少次期望在家吃着我做的炖土豆。</p>
<p>今年面试了不少人，通过面试也发现大部分技术人员的水平太差了，我甚至都搞不明白他们是怎么厚着脸皮来面试技术岗位的。济南软件行业实在是不景气，甚至找一个靠谱点的web或者php程序员都成为了公司的一大难题。</p>
<h1 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h1><p>长达五年的恋情在今年终于得到了升华，当然这升华是我不愿意这么快就看到的，多么希望能迟来几年，给原本一直以为自己还是个孩子的我一个接受的缓冲区，但站在两家人面前，我的想法竟然不能主导我。我对结婚这件事情持怎么简单怎么办的态度，结婚本就一仪式，豪华也罢，没有也罢，都是过眼云烟，为一天忙碌了一阵子仅为了那一天，而之后又有谁记得。结婚之所以在中国的古代非常重视，那是因为在农业社会中人民的娱乐方式非常单一，结婚可以成为人民心中的一个盼头和没有灯光的饭后侃的资本，现在娱乐方式早已多元化，相比之下结婚的光鲜早已显得微不足道。可结婚毕竟不是我一个人的事，甚至不是两个人的事，而是两家人的事。</p>
<p>结婚定在酷夏，定下来的时间比较匆忙，从定下来要结婚到结婚仅一个月时间，对我来说是莫大的好事，因为拖得时间越长占用的准备时间就越多。半年的婚前和半年的婚后生活，其实真的没人什么两样，都是美满的二人世界，希望这种状况能持续几年。</p>
<p>我一向对车比较排斥，始终认为汽车是一个比较失败的发明，用户体验特别差。好的设计应该让用户忽略其内部实现细节，好的发明不应该让用户花费大量的时间来学习怎样使用，甚至需要多个课时的专业培训。汽车不仅是一个毫无用户体验的发明，而且危险到极致，危险到一失误就会要掉人的性命。</p>
<p>但今年我随波逐流了，毕竟驾照是早晚要考的，晚考成本只会更高。于是考驾照提上了议程，8月初已经计划报名，只可惜流程过于复杂，到现在也才到了科目二的程度。先是报名需要办暂住证，暂住证一办就是15个工作日，直接拖到了十一之后。找个离家近的驾校报个名，一等就是一个月才考科目一。科目一考完一等又是一个月才开始分车学科目二。科目二刚开始学又开始继续了，一共练了两个工作日后驾校又开始集训了，又没我啥事了。好在我找了个陪练，练了几把就顺手了。</p>
<p>虽然驾照没有考出来，仅考到了科目二，算是完成了驾照的一半，但却耗去了我的部分经历。找驾校、准备科目一、学习科目二、找陪练，这些花费的都是我的时间。要是驾校培训行业能够再成熟些，再人性化些能给多少学车的人带来方便。</p>
<p>玩游戏多少有些过了，虽然每周也就不想学习的两个晚上用来玩游戏，但我深知自己不是玩游戏的料。很多时候为了能够赢一局，会熬夜到下半夜，这是非常不理智的。另外，以后尽量用其他方式来代替游戏放松，当然我深知其中的苦难。</p>
<h1 id="旅行"><a href="#旅行" class="headerlink" title="旅行"></a>旅行</h1><p>去过一次云南，都在<a href="http://www.kuring.me/post/yunan_travel" target="_blank" rel="external">这里</a>了。</p>
<p>清明节时间去过一次天津，天津比我想象的要好很多，各个地方特色比较明显，有别墅区、意大利风情区、现代的商业区等，这之间能够非常明显的区分，不像济南太混杂。不过天津的人却给我留下的印象不是很好，这也是小小的遗憾。</p>
<h1 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h1><p>在我心中已经为2015年制定好了一些计划，为家庭，为自己，2015年会是我人生的一个转折点，期望2015年能够顺利。我会努力的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/Maximum_Subarray/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/Maximum_Subarray/" itemprop="url">
                  leetcode题目之Maximum Subarray
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-01-02T00:00:00+08:00">
                2015-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><p>Find the contiguous subarray within an array (containing at least one number) which has the largest sum.</p>
<p>For example, given the array [−2,1,−3,4,−1,2,1,−5,4],<br>the contiguous subarray [4,−1,2,1] has the largest sum = 6.</p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>该题目为经典题目，存在多种解题思路。</p>
<h1 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h1><p>求动态规划的关键在于找到状态方程。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 问题的关键是找到状态方式，找到状态方程后问题就迎刃而解</div><div class="line"> * 状态方程如下：</div><div class="line"> * b[j]表示第j处，以a[j]结尾的子序列的最大和</div><div class="line"> * b[j]=max(a[j] + b[j-1], a[j])</div><div class="line"> * b数据的最大值即为问题的解</div><div class="line"> * 问题转换为求解b数组</div><div class="line"> * 时间复杂度为O(1)，空间复杂度为(n)，空间复杂度可以降为O(1)，为了使程序易读，不做调整</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> *b = <span class="keyword">new</span> <span class="keyword">int</span>[n];</div><div class="line">	b[<span class="number">0</span>] = A[<span class="number">0</span>];</div><div class="line">	<span class="keyword">int</span> max_b = b[<span class="number">0</span>];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;n; i++)</div><div class="line">	&#123;</div><div class="line">		b[i] = <span class="built_in">std</span>::max(A[i] + b[i<span class="number">-1</span>], A[i]);</div><div class="line">		<span class="keyword">if</span> (max_b &lt; b[i])</div><div class="line">		&#123;</div><div class="line">			max_b = b[i];</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">delete</span>[] b;</div><div class="line">	<span class="keyword">return</span> max_b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="分治法"><a href="#分治法" class="headerlink" title="分治法"></a>分治法</h1><p>《算法导论》的分治策略一章有关于该问题的详细解释。该题利用分治法来解决要比二分查找类最简单的分治算法要复杂。将数组一分为二后，最大数组存在三种情况：在左半或右半部分、跨越中点分别占据左部分一点和右部分一点。对于跨越中点的情况，转化为求从中点开始向左的最大值和从中点开始向右的最大值之和。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">class</span> Solution &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">int</span> compare_array[<span class="number">4</span>];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> maxSubArray(A, <span class="number">0</span>, n - <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * leetcode not support stdarg.h</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">int</span> count, ...)</span></span></div><div class="line">    &#123;</div><div class="line">        va_list ap;</div><div class="line">        va_start(ap, count);</div><div class="line">        <span class="keyword">int</span> max = INT_MIN;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> temp = va_arg(ap, <span class="keyword">int</span>);</div><div class="line">            <span class="keyword">if</span> (max &lt; temp)</div><div class="line">            &#123;</div><div class="line">                max = temp;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        va_end(ap);</div><div class="line">        <span class="keyword">return</span> max;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">max_compare_array</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> max_num = compare_array[<span class="number">0</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;<span class="number">4</span>; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (max_num &lt; compare_array[i])</div><div class="line">            &#123;</div><div class="line">                max_num = compare_array[i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> max_num;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">//printf("begin : %d, end : %d\n", begin, end);</span></div><div class="line">        <span class="keyword">if</span> (begin == end)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> A[begin];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((end - begin) == <span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//return max(3, A[begin], A[begin] + A[end], A[end]);</span></div><div class="line">            compare_array[<span class="number">0</span>] = A[begin];</div><div class="line">            compare_array[<span class="number">1</span>] = A[begin] + A[end];</div><div class="line">            compare_array[<span class="number">2</span>] = A[end];</div><div class="line">            compare_array[<span class="number">3</span>] = INT_MIN;</div><div class="line">            <span class="keyword">return</span> max_compare_array();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> middle = (begin + end) / <span class="number">2</span>;</div><div class="line">        <span class="comment">// 处理左边子数组</span></div><div class="line">        <span class="keyword">int</span> max_left = maxSubArray(A, begin, middle);</div><div class="line">        <span class="comment">// 处理右边子数组</span></div><div class="line">        <span class="keyword">int</span> max_right = maxSubArray(A, middle + <span class="number">1</span>, end);</div><div class="line">        <span class="comment">// 处理跨越中点的情况</span></div><div class="line">        <span class="keyword">int</span> max_cross = maxCrossMiddle(A, begin, end);</div><div class="line"></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"begin : %d, end : %d, max_left = %d, max_right = %d, max_cross = %d\n"</span>, begin, end, max_left, max_right, max_cross);</div><div class="line"></div><div class="line">        <span class="comment">// 返回三者中的最大值</span></div><div class="line">        compare_array[<span class="number">0</span>] = max_left;</div><div class="line">        compare_array[<span class="number">1</span>] = max_right;</div><div class="line">        compare_array[<span class="number">2</span>] = max_cross;</div><div class="line">        compare_array[<span class="number">3</span>] = INT_MIN;</div><div class="line">        <span class="keyword">return</span> max_compare_array();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 处理跨越中点的情况</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxCrossMiddle</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> begin, <span class="keyword">int</span> end)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (begin == end)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">return</span> A[begin];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> middle = (begin + end) / <span class="number">2</span>;</div><div class="line">        <span class="comment">// 求得[begin -- middle-1]的最大值</span></div><div class="line">        <span class="keyword">int</span> max_left = A[middle - <span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=middle - <span class="number">1</span>; i&gt;=begin &amp;&amp; i &gt;= <span class="number">0</span>; i--)</div><div class="line">        &#123;</div><div class="line">            sum += A[i];</div><div class="line">            <span class="keyword">if</span> (max_left &lt; sum)</div><div class="line">            &#123;</div><div class="line">                max_left = sum;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 求得[middle+1 -- end]的最大值</span></div><div class="line">        <span class="keyword">int</span> max_right = A[middle + <span class="number">1</span>];</div><div class="line">        sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=middle + <span class="number">1</span>; i&lt;=end; i++)</div><div class="line">        &#123;</div><div class="line">            sum += A[i];</div><div class="line">            <span class="keyword">if</span> (max_right&lt; sum)</div><div class="line">            &#123;</div><div class="line">                max_right = sum;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        compare_array[<span class="number">0</span>] = A[middle];</div><div class="line">        compare_array[<span class="number">1</span>] = A[middle] + max_left;</div><div class="line">        compare_array[<span class="number">2</span>] = A[middle] + max_right;</div><div class="line">        compare_array[<span class="number">3</span>] = A[middle] + max_left + max_right;</div><div class="line">        <span class="keyword">return</span> max_compare_array();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h1 id="扫描算法"><a href="#扫描算法" class="headerlink" title="扫描算法"></a>扫描算法</h1><p>《编程珠玑》一书8.4节提到该算法，时间复杂度为O(1)，是解决该问题最好的算法。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">maxSubArray</span><span class="params">(<span class="keyword">int</span> A[], <span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> current_sum = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> max_sum = INT_MIN;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++)</div><div class="line">	&#123;</div><div class="line">	    <span class="keyword">if</span> (current_sum &lt;= <span class="number">0</span>)</div><div class="line">	    &#123;</div><div class="line">		current_sum = A[i];</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">else</span></div><div class="line">	    &#123;</div><div class="line">		current_sum += A[i];</div><div class="line">	    &#125;</div><div class="line">	    <span class="keyword">if</span> (current_sum &gt; max_sum)</div><div class="line">	    &#123;</div><div class="line">		max_sum = current_sum;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> max_sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/linux_signal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/linux_signal/" itemprop="url">
                  Linux信号机制学习
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-22T00:00:00+08:00">
                2014-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>[TOC]</p>
<p>信号机制在Linux编程中一直是一个难点，因为信号往往跟进程、线程、定时器、I/O等多个层面都有牵涉，这些情况存在错综复杂的关系，堪比娱乐圈错综复杂的男女关系，要想全面理解信号机制确实不易。</p>
<h1 id="信号种类"><a href="#信号种类" class="headerlink" title="信号种类"></a>信号种类</h1><p>在Linux中可以通过如下命令来查看所有的信号：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[kuring@localhost ~]$ kill -l</div><div class="line"> 1) SIGHUP       2) SIGINT       3) SIGQUIT      4) SIGILL       5) SIGTRAP</div><div class="line"> 6) SIGABRT      7) SIGBUS       8) SIGFPE       9) SIGKILL     10) SIGUSR1</div><div class="line">11) SIGSEGV     12) SIGUSR2     13) SIGPIPE     14) SIGALRM     15) SIGTERM</div><div class="line">16) SIGSTKFLT   17) SIGCHLD     18) SIGCONT     19) SIGSTOP     20) SIGTSTP</div><div class="line">21) SIGTTIN     22) SIGTTOU     23) SIGURG      24) SIGXCPU     25) SIGXFSZ</div><div class="line">26) SIGVTALRM   27) SIGPROF     28) SIGWINCH    29) SIGIO       30) SIGPWR</div><div class="line">31) SIGSYS      34) SIGRTMIN    35) SIGRTMIN+1  36) SIGRTMIN+2  37) SIGRTMIN+3</div><div class="line">38) SIGRTMIN+4  39) SIGRTMIN+5  40) SIGRTMIN+6  41) SIGRTMIN+7  42) SIGRTMIN+8</div><div class="line">43) SIGRTMIN+9  44) SIGRTMIN+10 45) SIGRTMIN+11 46) SIGRTMIN+12 47) SIGRTMIN+13</div><div class="line">48) SIGRTMIN+14 49) SIGRTMIN+15 50) SIGRTMAX-14 51) SIGRTMAX-13 52) SIGRTMAX-12</div><div class="line">53) SIGRTMAX-11 54) SIGRTMAX-10 55) SIGRTMAX-9  56) SIGRTMAX-8  57) SIGRTMAX-7</div><div class="line">58) SIGRTMAX-6  59) SIGRTMAX-5  60) SIGRTMAX-4  61) SIGRTMAX-3  62) SIGRTMAX-2</div><div class="line">63) SIGRTMAX-1  64) SIGRTMAX</div></pre></td></tr></table></figure>
<p>共64个信号，分为两种信号：非实时信号和实时信号。其中1-31个信号为非实时信号，32-64为实时信号。</p>
<p>当一信号在阻塞状态下产生多次信号，当解除该信号的阻塞后，非实时信号仅传递一次信号，而实时信号会传递多次。</p>
<p>对于非实时信号：内核会为每个信号维护一个信号掩码，并阻塞信号针对该进程的传递。如果将阻塞的信号发送给某进程，对该信号的传递将延时，直至从进程掩码中移除该信号为止。当从进程掩码中移除该信号时该信号将传递给该进程。如果信号在阻塞期间传递过多次该信号，信号解除阻塞后仅传递一次。</p>
<p>对于实时信号：实时信号采用队列化处理，一个实时信号的多个实例发送给进程，信号将会传递多次。可以制定伴随数据，用于产生信号时的数据传递。不同实时信号的传递顺序是固定的，优先传递信号编号小的。</p>
<h1 id="信号阻塞"><a href="#信号阻塞" class="headerlink" title="信号阻塞"></a>信号阻塞</h1><p>内核会为每个信号维护一个信号掩码，来阻塞内核将信号传递给该进程。如果将阻塞的信号发送给该进程，信号的传递将延后，从进程信号掩码中移除该信号后内核立刻将信号传递给该进程。如果一个信号在阻塞状态下产生多次，对于非实时信号稍后仅会传递一次，对于实时信号内核会进行排队处理，会传递多次。</p>
<h1 id="信号处理函数"><a href="#信号处理函数" class="headerlink" title="信号处理函数"></a>信号处理函数</h1><p>要想在进程中设置信号处理函数有两种选择：signal()和sigaction()。其中signal()函数提供的接口比较简单，但是在不同的UNIX系统之间存在差异，跨平台特性不是很好,signal()函数由于是C库函数，实现往往是采用sigaction()系统调用完成。sigaction()具有很好的跨平台性，但是使用较为复杂，但是却可以在信号处理程序中完成阻塞信号的作用。</p>
<p>在sigaction函数中可以指定调用信号处理函数时要阻塞的信号集，不允许这些信号中断信号处理函数的调用，直到信号处理函数调用完毕后信号才会传递。这一点通过signal函数是完不成的，利用signal函数设定的信号处理函数只能在信号处理函数开始时使用sigprocmask设置要阻塞的信号，在信号处理函数尾部利用sigprocmask还原信号，但在调用第一次调用sigprocmask函数之前和第二次调用sigprocmask函数之后的空白期内却无法防止要阻塞信号的传递。</p>
<p>信号处理函数中调用的函数尽量是异步信号安全的，C库中的函数不是异步信号安全的函数。</p>
<p>在信号处理函数中尽量避免访问全局变量，要访问全局变量可以使用<code>volatile sig_atomic_t flag</code>，volatile防止将编译器将变量优化到内存中，sig_atomic_t是一种整形数据类型，用来保证读写操作的原子性。</p>
<h1 id="系统调用的中断"><a href="#系统调用的中断" class="headerlink" title="系统调用的中断"></a>系统调用的中断</h1><p>当系统调用阻塞时，之前创建了处理函数的信号传递过来。在信号处理函数返回后，默认情况下，系统调用会失败，并将errno置为EINTR。</p>
<p>如果调用指定了SA_RESTART标志的sigaction()函数来创建信号处理器函数，内核会在信号处理函数返回后自动重启系统调用，从而避免了信号处理函数对阻塞的系统调用产生的影响。比较不幸的是，并非所有的系统调用都支持该特性。</p>
<h1 id="信号的同步生成和异步生成"><a href="#信号的同步生成和异步生成" class="headerlink" title="信号的同步生成和异步生成"></a>信号的同步生成和异步生成</h1><p>这里的同步是对信号产生方式的描述，跟具体哪个信号无关。所有的信号均可同步生成，也可异步生成。</p>
<p>异步生成：引发信号产生的事件与进程的执行无关。例如，用户输入了中断字符、子进程终止等事件，这些信号的产生该进程是无法左右的。</p>
<p>同步生成：当执行特定的机制指令产生硬件异常时或进程使用raise()、kill()等向自身发生信号时，信号是同步传递的。这些信号的产生时间该进程是可以左右的。</p>
<h1 id="信号传递的时机和顺序"><a href="#信号传递的时机和顺序" class="headerlink" title="信号传递的时机和顺序"></a>信号传递的时机和顺序</h1><p>同步产生的信号会立即传递给该进程。例如，当使用raise()函数向自身发送信号时，信号会在raise()调用前发生。</p>
<p>异步产生一个信号时，且在进程并未阻塞的情况下，信号也不会立即被传递。当且仅当进程正在执行，并且由内核态到用户态的下一次切换时才会传递信号。说人话就是在以下两种情况下会传递信号：进程获得调度时和系统调用完成时。这是因为内核会在进程在内核态和用户态进行的切换的时候才会检测信号。</p>
<p>非实时信号的传递顺序无法保障，实时信号的传递顺序是固定的，当多个不同的实时信号处于等待状态时，优先传递最小编号的信号。</p>
<h1 id="信号和线程"><a href="#信号和线程" class="headerlink" title="信号和线程"></a>信号和线程</h1><p>信号模型是基于进程模型而设计的，应尽量避免在多线程中使用信号模型。</p>
<p>信号的发送可以针对整个进程，也可以针对特定线程。</p>
<p>当进程收到一个信号后，内核会任选一个线程来接收信号，并调用信号处理函数对信号进行处理。</p>
<p>每个线程可以独立设置信号掩码。</p>
<p>如果信号处理程序中断了对pthread_mutex_lock()和pthread_cond_wait()的调用，该调用会自动重启。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p>《Linux/Unix系统编程手册》</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/linux_unp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/linux_unp/" itemprop="url">
                  UNIX网络编程读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-22T00:00:00+08:00">
                2014-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>第一遍阅读unpv3后，对书中讲述的内容有了大体的认识，但对书中的具体细节地方却是早已忘记。重新阅读unpv3，这次不希望仍然是阅后即忘，于是通过编写代码的方式对书中的例子和注意事项加深理解。</p>
<p>为了能够将书中的很多细节问题理解清楚并且便于记忆，本文采用了编写书中代码并运行的方式，并将书中容易出错和意想不到的问题记在代码中。</p>
<p>本文的代码实例并未完全按照书中的代码实例，本着单个文件即能编译通过并运行的原则，本文对于很多系统调用并未做防御式编程处理。针对每个版本的程序中缺点和注意事项在代码中已经进行了标注。</p>
<p>鉴于高性能的epoll机制出现比较晚，晚于unp的编写时间，书中并未做介绍。</p>
<h1 id="TCP客户端程序"><a href="#TCP客户端程序" class="headerlink" title="TCP客户端程序"></a>TCP客户端程序</h1><p>客户端函数执行效率情况：select非阻塞式I/O版本&gt;线程化版本&gt;fork版本&gt;select阻塞式I/O版本&gt;停等版本，停等版本的执行效率非常低，在实际生产环境中不建议使用。</p>
<p>其中poll和select机制基本类似，书中并未给出poll版本。</p>
<h2 id="停-等版本"><a href="#停-等版本" class="headerlink" title="停-等版本"></a>停-等版本</h2><p>最常规的实现思路，但效率非常低，且当程序阻塞在读取要发送内容时，程序是无法收到服务端的状态变化。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 停-等版本</div><div class="line"> * 该版本缺陷为当服务端发生某些事件时，客户端可能仍然阻塞于fgets调用中</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_cli</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> sendline[MAXLINE], recvline[MAXLINE];</div><div class="line">	<span class="keyword">while</span> (fgets(sendline, MAXLINE, fp) != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">/* 当阻塞在fgets函数时将服务器进程关闭时虽然给客户端发送了FIN信号，客户端并不会知道，</span></div><div class="line">		 * 服务端关闭时第一次调用write服务器会返回RST，</div><div class="line">		 * 当一个进程向某个收到RST的套接字执行写操作时，内核会向该进程发送一个SIGPIPE信号</div><div class="line">		 * 该问题需要使用I/O复用技术来解决，或者使用fork处理的方式来解决</div><div class="line">		 * */</div><div class="line">		write(sockfd, sendline, <span class="built_in">strlen</span>(sendline));</div><div class="line">		<span class="keyword">int</span> n = read(sockfd, recvline, MAXLINE);</div><div class="line">		<span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"str_cli: server terminated prematurely\n"</span>);</div><div class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 向标准输出写内容，既可以使用write也可以使用fputs</span></div><div class="line">		write(STDOUT_FILENO, recvline, n);</div><div class="line"></div><div class="line">		<span class="comment">// 使用fputs时需要注意将recvline数组有效内容的后面一位设置为'\0'</span></div><div class="line"><span class="comment">//		recvline[n] = '\0';</span></div><div class="line"><span class="comment">//		fputs(recvline, stdout);</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd;</div><div class="line">	<span class="keyword">struct</span> sockaddr_in	servaddr;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"usage: tcpcli &lt;IPaddress&gt;\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 当一个进程向某个收到RST的套接字执行写操作时，内核会向该进程发送一个SIGPIPE信号</span></div><div class="line">	<span class="comment">// 最好的方式是忽略此信号的处理方式，并在程序下面处理该异常情况</span></div><div class="line">	signal(SIGPIPE, SIG_IGN);</div><div class="line"></div><div class="line">	sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;servaddr.sin_addr);</div><div class="line"></div><div class="line">	connect(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line"></div><div class="line">	str_cli(<span class="built_in">stdin</span>, sockfd);		<span class="comment">/* do it all */</span></div><div class="line"></div><div class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="fork版本"><a href="#fork版本" class="headerlink" title="fork版本"></a>fork版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 阻塞式I/O的fork版本</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 即使服务端已经退出，子进程的read方法仍然能够感知到并且退出while循环，并给父进程发送SIGTERM,父进程对该信号的默认处理方式为退出</div><div class="line"> * 优点：代码量比较少，每个进程只处理2个I/O流，从一个复制到另一个</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_cli</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> sendline[MAXLINE], recvline[MAXLINE];</div><div class="line">	<span class="keyword">pid_t</span> pid;</div><div class="line">	<span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// child process : server -&gt; stdout</span></div><div class="line">		<span class="keyword">int</span> n;</div><div class="line">		<span class="keyword">while</span> ((n = read(sockfd, recvline, MAXLINE)) &gt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			recvline[n] = <span class="string">'\0'</span>;</div><div class="line">			<span class="built_in">fputs</span>(recvline, <span class="built_in">stdout</span>);</div><div class="line">		&#125;</div><div class="line">		kill(getppid(), SIGTERM);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// parent process : stdin -&gt; server</span></div><div class="line">	<span class="keyword">while</span> (fgets(sendline, MAXLINE, fp) != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		write(sockfd, sendline, <span class="built_in">strlen</span>(sendline));</div><div class="line">	&#125;</div><div class="line">	shutdown(sockfd, SHUT_WR);</div><div class="line">	pause();</div><div class="line">	<span class="keyword">return</span> ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd;</div><div class="line">	<span class="keyword">struct</span> sockaddr_in	servaddr;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"usage: tcpcli &lt;IPaddress&gt;\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 当一个进程向某个收到RST的套接字执行写操作时，内核会向该进程发送一个SIGPIPE信号</span></div><div class="line">	<span class="comment">// 最好的方式是忽略此信号的处理方式，并在程序下面处理该异常情况</span></div><div class="line">	signal(SIGPIPE, SIG_IGN);</div><div class="line"></div><div class="line">	sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;servaddr.sin_addr);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (connect(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) != <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"connect error...\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	str_cli(<span class="built_in">stdin</span>, sockfd);		<span class="comment">/* do it all */</span></div><div class="line"></div><div class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="阻塞式I-O的select版本"><a href="#阻塞式I-O的select版本" class="headerlink" title="阻塞式I/O的select版本"></a>阻塞式I/O的select版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 阻塞式I/O的select版本</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 缺点：使用了阻塞式I/O，如果在向套接字调用write发送给服务器时，套接字缓冲区已满，write调用会阻塞，从而影响了后续的套接字缓冲区的读取</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_cli</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> maxfdp1;</div><div class="line">	fd_set rset;</div><div class="line">	<span class="keyword">char</span> sendline[MAXLINE], recvline[MAXLINE];</div><div class="line">	<span class="keyword">int</span> stdineof = <span class="number">0</span>;</div><div class="line">	FD_ZERO(&amp;rset);</div><div class="line">	<span class="keyword">for</span> (; ;)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// select</span></div><div class="line">		FD_SET(fileno(fp), &amp;rset);</div><div class="line">		FD_SET(sockfd, &amp;rset);</div><div class="line">		maxfdp1 = (fileno(fp) &gt; sockfd ? fileno(fp) : sockfd) + <span class="number">1</span>;</div><div class="line">		select(maxfdp1, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">		<span class="comment">// socket</span></div><div class="line">		<span class="keyword">if</span> (FD_ISSET(sockfd, &amp;rset))</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> n = read(sockfd, recvline, MAXLINE);</div><div class="line">			<span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (stdineof == <span class="number">1</span>)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">return</span> ;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span></div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"str_cli: server terminated prematurely\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">-1</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">			recvline[n] = <span class="string">'\0'</span>;</div><div class="line">			<span class="built_in">fputs</span>(recvline, <span class="built_in">stdout</span>);</div><div class="line"><span class="comment">//			write(STDOUT_FILENO, recvline, n);</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// input</span></div><div class="line">		<span class="keyword">if</span> (FD_ISSET(fileno(fp), &amp;rset))</div><div class="line">		&#123;</div><div class="line">			<span class="comment">// 此处不能使用fgets函数，该函数带有缓冲区功能，select跟带有缓冲区的c函数混合使用有问题</span></div><div class="line"><span class="comment">//			if (fgets(sendline, MAXLINE, fp) == NULL)</span></div><div class="line"><span class="comment">//			&#123;</span></div><div class="line"><span class="comment">//				return ;</span></div><div class="line"><span class="comment">//			&#125;</span></div><div class="line">			<span class="keyword">int</span> n = read(fileno(fp), sendline, MAXLINE);</div><div class="line">			<span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				stdineof = <span class="number">1</span>;</div><div class="line">				shutdown(sockfd, SHUT_WR);	<span class="comment">// 关闭写</span></div><div class="line">				FD_CLR(fileno(fp), &amp;rset);</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">-1</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">			write(sockfd, sendline, n);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd;</div><div class="line">	<span class="keyword">struct</span> sockaddr_in	servaddr;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"usage: tcpcli &lt;IPaddress&gt;\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;servaddr.sin_addr);</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (connect(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) != <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"connect error...\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	str_cli(<span class="built_in">stdin</span>, sockfd);		<span class="comment">/* do it all */</span></div><div class="line"></div><div class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="非阻塞式I-O的select版本"><a href="#非阻塞式I-O的select版本" class="headerlink" title="非阻塞式I/O的select版本"></a>非阻塞式I/O的select版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 非阻塞式I/O的select版本</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE 4096	<span class="comment">/* max text line length */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> max(a,b) ( ((a)&gt;(b)) ? (a):(b) )</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 优点：速度是最快的，可以防止进程在做任何工作时发生阻塞</div><div class="line"> * 缺点：同时管理4个不同的I/O流，每个流都是非阻塞的，需要考虑到4个流的部分读和部分写问题。编码量是最多的，需要引入缓冲区管理机制。</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_cli</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 将socket、标准输入和标准输出描述符设置为非阻塞方式</span></div><div class="line">	<span class="keyword">int</span> val = fcntl(sockfd, F_GETFL, <span class="number">0</span>);</div><div class="line">	fcntl(sockfd, F_SETFL, val | O_NONBLOCK);</div><div class="line"></div><div class="line">	val = fcntl(STDIN_FILENO, F_GETFL, <span class="number">0</span>);</div><div class="line">	fcntl(STDIN_FILENO, F_SETFL, val | O_NONBLOCK);</div><div class="line"></div><div class="line">	val = fcntl(STDOUT_FILENO, F_GETFL, <span class="number">0</span>);</div><div class="line">	fcntl(STDOUT_FILENO, F_SETFL, val | O_NONBLOCK);</div><div class="line"></div><div class="line">	<span class="keyword">char</span> to[MAXLINE], fr[MAXLINE];</div><div class="line">	<span class="keyword">char</span> *toiptr, *tooptr, *friptr, *froptr;</div><div class="line">	toiptr = tooptr = to;</div><div class="line">	friptr = froptr = fr;</div><div class="line">	<span class="keyword">int</span> stdineof = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxfdp1 = max(max(STDIN_FILENO, STDOUT_FILENO), sockfd) + <span class="number">1</span>;</div><div class="line">	fd_set rset, wset;</div><div class="line">	<span class="keyword">for</span> (; ;)</div><div class="line">	&#123;</div><div class="line">		FD_ZERO(&amp;rset);</div><div class="line">		FD_ZERO(&amp;wset);</div><div class="line">		<span class="keyword">if</span> (stdineof == <span class="number">0</span> &amp;&amp; toiptr &lt; &amp;to[MAXLINE])</div><div class="line">		&#123;</div><div class="line">			FD_SET(STDIN_FILENO, &amp;rset);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (friptr &lt; &amp;fr[MAXLINE])</div><div class="line">		&#123;</div><div class="line">			FD_SET(sockfd, &amp;rset);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (tooptr != toiptr)</div><div class="line">		&#123;</div><div class="line">			FD_SET(sockfd, &amp;wset);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (froptr != friptr)</div><div class="line">		&#123;</div><div class="line">			FD_SET(STDOUT_FILENO, &amp;wset);</div><div class="line">		&#125;</div><div class="line">		select(maxfdp1, &amp;rset, &amp;wset, <span class="literal">NULL</span>, <span class="literal">NULL</span>);	<span class="comment">// select函数仍然是阻塞的</span></div><div class="line">		<span class="comment">// 标准输入</span></div><div class="line">		<span class="keyword">if</span> (FD_ISSET(STDIN_FILENO, &amp;rset))</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> n;</div><div class="line">			<span class="keyword">if</span> ((n = read(STDIN_FILENO, toiptr, &amp;to[MAXLINE] - toiptr)) &lt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="comment">// 对于非阻塞式IO，如果操作不能满足，相应系统调用会返回EWOULDBLOCK错误</span></div><div class="line">				<span class="keyword">if</span> (errno != EWOULDBLOCK)</div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"read error on stdin\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"EOF on stdin\n"</span>);</div><div class="line">				stdineof = <span class="number">1</span>;</div><div class="line">				<span class="keyword">if</span> (tooptr == toiptr)</div><div class="line">				&#123;</div><div class="line">					shutdown(sockfd, SHUT_WR);	<span class="comment">// 缓冲区中没有数据要发送，关闭socket</span></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"read %d bytes from stdin\n"</span>, n);</div><div class="line">				toiptr += n;</div><div class="line">				FD_SET(sockfd, &amp;wset);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 从套接字读</span></div><div class="line">		<span class="keyword">if</span> (FD_ISSET(sockfd, &amp;rset))</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> n;</div><div class="line">			<span class="keyword">if</span> ((n = read(sockfd, friptr, &amp;fr[MAXLINE] - friptr)) &lt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (errno != EWOULDBLOCK)</div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"read error on socket\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"EOF on socket\n"</span>);</div><div class="line">				<span class="keyword">if</span> (stdineof)</div><div class="line">				&#123;</div><div class="line">					<span class="keyword">return</span> ;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">else</span></div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"server terminated prematurely\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"read %d bytes from socket\n"</span>, n);</div><div class="line">				friptr += n;</div><div class="line">				FD_SET(STDOUT_FILENO, &amp;wset);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 标准输出</span></div><div class="line">		<span class="keyword">int</span> n;</div><div class="line">		<span class="keyword">if</span> (FD_ISSET(STDOUT_FILENO, &amp;wset) &amp;&amp; ((n = friptr - froptr) &gt; <span class="number">0</span>))</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> nwritten;</div><div class="line">			<span class="keyword">if</span> ((nwritten = write(STDOUT_FILENO, froptr, n)) &lt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (errno != EWOULDBLOCK)</div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"write error to stdout\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"wrote %d bytes to stdout\n"</span>, nwritten);</div><div class="line">				froptr += nwritten;</div><div class="line">				<span class="keyword">if</span> (froptr == friptr)</div><div class="line">				&#123;</div><div class="line">					froptr = friptr = fr;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 向socket写</span></div><div class="line">		<span class="keyword">if</span> (FD_ISSET(sockfd, &amp;wset) &amp;&amp; ((n = toiptr - tooptr)) &gt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">int</span> nwritten;</div><div class="line">			<span class="keyword">if</span> ((nwritten = write(sockfd, tooptr, n)) &lt; <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (errno != EWOULDBLOCK)</div><div class="line">				&#123;</div><div class="line">					<span class="built_in">printf</span>(<span class="string">"write error to socket\n"</span>);</div><div class="line">					<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"wrote %d bytes to socket\n"</span>, nwritten);</div><div class="line">				tooptr += nwritten;</div><div class="line">				<span class="keyword">if</span> (tooptr == toiptr)</div><div class="line">				&#123;</div><div class="line">					toiptr = tooptr = to;</div><div class="line">					<span class="keyword">if</span> (stdineof)</div><div class="line">					&#123;</div><div class="line">						shutdown(sockfd, SHUT_WR);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> ;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * connect的非阻塞版本</div><div class="line"> * 连接建立成功时，描述符变为可写；连接建立错误时，描述符变为即可读又可写</div><div class="line"> * 优点：</div><div class="line"> * 1、阻塞式的connect调用会消耗CPU时间，非阻塞式connect可以充分利用CPU时间，在等待的过程中可以处理其他工作</div><div class="line"> * 2、可以同时建立多个连接，浏览器中会用到此技术</div><div class="line"> * 3、阻塞式connect的函数超时过长，可以通过该函数设置超时时间</div><div class="line"> * 4、阻塞式的套接字调用connect时，在TCP的三次握手完成之前被某些信号中断时并且connect未设置内核自动重启的标志时，connect将返回EINTR错误</div><div class="line"> * 当再次调用connect等待未完成的连接时将会返回EADDRINUSE错误</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect_nonb</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *saptr, <span class="keyword">socklen_t</span> salen, <span class="keyword">int</span> nsec)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">// 将套接字设置为非阻塞状态</span></div><div class="line">	<span class="keyword">int</span> flags = fcntl(sockfd, F_GETFL, <span class="number">0</span>);</div><div class="line">	fcntl(sockfd, F_SETFL, flags | O_NONBLOCK);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> error = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> n;</div><div class="line">	<span class="keyword">if</span> ((n = connect(sockfd, saptr, salen)) &lt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 连接未成功建立，正常情况下返回EINPROGRESS错误，表示操作正在处理</span></div><div class="line">		<span class="keyword">if</span> (errno != EINPROGRESS)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">// EINPROGRESS表示连接建立已经启动，但是尚未完成</span></div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 当服务器和客户端在一台主机上时会立即建立连接</span></div><div class="line">		<span class="keyword">goto</span> done;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 当代码执行到如下过程中时，connect正在建立连接，可以在此位置执行业务相关代码</span></div><div class="line">	<span class="comment">// 当然真正使用时，在此位置加入其他代码并不合适，需要根据具体情况重新调整代码</span></div><div class="line">	<span class="comment">// 可以参照书中的web客户程序例子</span></div><div class="line"></div><div class="line">	fd_set rset, wset;</div><div class="line">	FD_ZERO(&amp;rset);</div><div class="line">	FD_SET(sockfd, &amp;rset);</div><div class="line">	wset = rset;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> timeval tval;</div><div class="line">	tval.tv_sec = nsec;</div><div class="line">	tval.tv_usec = <span class="number">0</span>;</div><div class="line">	<span class="keyword">if</span> ((n = select(sockfd + <span class="number">1</span>, &amp;rset, &amp;wset, <span class="literal">NULL</span>, nsec ? &amp;tval : <span class="literal">NULL</span>)) == <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 发生超时</span></div><div class="line">		close(sockfd);</div><div class="line">		errno = ETIMEDOUT;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 当连接建立成功时sockfd变为可写，当连接建立失败时sockfd变为即可读又可写</span></div><div class="line">	<span class="keyword">if</span> (FD_ISSET(sockfd, &amp;rset) || FD_ISSET(sockfd, &amp;wset))</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">int</span> len = <span class="keyword">sizeof</span>(error);</div><div class="line">		<span class="comment">// 非可移植性函数，连接建立成功返回0，连接建立失败将错误值返回给error</span></div><div class="line">		<span class="comment">// 连接建立失败时，有返回-1和返回0的情况</span></div><div class="line">		<span class="keyword">if</span> (getsockopt(sockfd, SOL_SOCKET, SO_ERROR, &amp;error, &amp;len) &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">// solaris连接建立失败返回-1</span></div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">else</span></div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"select error:sockfd not set"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line">done:</div><div class="line">	<span class="comment">// 恢复套接字的文件状态标志</span></div><div class="line">	fcntl(sockfd, F_SETFL, flags);</div><div class="line">	<span class="keyword">if</span> (error)</div><div class="line">	&#123;</div><div class="line">		close(sockfd);</div><div class="line">		errno = error;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd;</div><div class="line">	<span class="keyword">struct</span> sockaddr_in	servaddr;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"usage: tcpcli &lt;IPaddress&gt;\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 当一个进程向某个收到RST的套接字执行写操作时，内核会向该进程发送一个SIGPIPE信号</span></div><div class="line">	<span class="comment">// 最好的方式是忽略此信号的处理方式，并在程序下面处理该异常情况</span></div><div class="line">	signal(SIGPIPE, SIG_IGN);</div><div class="line"></div><div class="line">	sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line"></div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;servaddr.sin_addr);</div><div class="line"></div><div class="line">	<span class="comment">//connect(sockfd, (struct sockaddr*)&amp;servaddr, sizeof(servaddr));</span></div><div class="line">	<span class="keyword">if</span> (connect_nonb(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr), <span class="number">50</span>) &lt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"socket connect error\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	str_cli(<span class="built_in">stdin</span>, sockfd);		<span class="comment">/* do it all */</span></div><div class="line"></div><div class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="TCP服务端程序"><a href="#TCP服务端程序" class="headerlink" title="TCP服务端程序"></a>TCP服务端程序</h1><p>服务器程序要处理大量并发，在设计时更要注重效率。</p>
<h2 id="fork版本-1"><a href="#fork版本-1" class="headerlink" title="fork版本"></a>fork版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * fork版本</div><div class="line"> * PPC(Process per Connection)模型</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sig_chld</span><span class="params">(<span class="keyword">int</span> signo)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (signo != SIGIO)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">int</span> stat;</div><div class="line"></div><div class="line">	<span class="comment">/* 此处不可以使用wait函数，当多个SIGCHLD信号同时发出时会因为信号覆盖而出现僵尸进程的情况</span></div><div class="line">	pid_t pid = wait(&amp;stat);</div><div class="line">	printf("child %d terminated\n", pid);	// 非异步信号安全函数，此处不应该调用</div><div class="line">	*/</div><div class="line"></div><div class="line">	<span class="comment">/* 使用非阻塞的参数WNOHANG来循环处理信号，避免信号丢失问题 */</span></div><div class="line">	<span class="keyword">pid_t</span> pid;</div><div class="line">	<span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;stat, WNOHANG)) &gt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"child %d terminated\n"</span>, pid);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_echo</span><span class="params">(<span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">ssize_t</span>	n;</div><div class="line">	<span class="keyword">char</span> buf[MAXLINE];</div><div class="line"></div><div class="line">again:</div><div class="line">	<span class="keyword">while</span> ( (n = read(sockfd, buf, MAXLINE)) &gt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		write(sockfd, buf, n);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR)</div><div class="line">		<span class="keyword">goto</span> again;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"str_echo: read error\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * fork版本</div><div class="line"> * 缺点：</div><div class="line"> * 		1.fork需要将父进程的内存映像复制到子进程，并在子进程中复制所有的描述符，尽管现在的操作系统已经都实现了写时复制技术，但是耗时仍然比较多</div><div class="line"> * 		2.父进程和子进程之间需要IPC机制进行通信，从子进程返回信息到父进程比较麻烦</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">	signal(SIGCHLD, sig_chld);</div><div class="line">    <span class="keyword">int</span> listenfd, connfd;</div><div class="line">    <span class="keyword">pid_t</span> childpid;</div><div class="line">    <span class="keyword">struct</span> sockaddr_in cliaddr, servaddr;</div><div class="line"></div><div class="line">    <span class="comment">// socket</span></div><div class="line">    listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"socket error\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="comment">// bind</span></div><div class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">    servaddr.sin_family = AF_INET;</div><div class="line">    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">    servaddr.sin_port = htons(SERV_PORT);</div><div class="line">    <span class="keyword">if</span> (bind(listenfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// listen</span></div><div class="line">    <span class="comment">// 套接字排队的最大连接数为20</span></div><div class="line">    <span class="keyword">if</span> (listen(listenfd, <span class="number">20</span>) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"listen error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( ; ; )</div><div class="line">    &#123;</div><div class="line">    	<span class="keyword">socklen_t</span> clilen = <span class="keyword">sizeof</span>(cliaddr);</div><div class="line">    	<span class="comment">// 处理accept被信号中断时返回EINTR错误</span></div><div class="line">		<span class="keyword">if</span> ((connfd = accept(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, &amp;clilen)) &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (errno == EINTR)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"accept error"</span>);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> ((childpid = fork()) == <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">/* child process */</span></div><div class="line">			close(listenfd); <span class="comment">/* close listening socket */</span></div><div class="line">			str_echo(connfd); <span class="comment">/* process the request */</span></div><div class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">		&#125;</div><div class="line">		close(connfd); <span class="comment">/* parent closes connected socket */</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="select版本"><a href="#select版本" class="headerlink" title="select版本"></a>select版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * select版本</div><div class="line"> * 缺点：</div><div class="line"> * 		1. 有最大并发数限制，一个进程最多打开FD_SETSIZE个文件描述符，FD_SETSIZE往往是1024或2048字节</div><div class="line"> * 		2. select每次调用都会线性扫描全部的FD集合，这样效率就会呈现线性下降，把FD_SETSIZE改大的后果就是所有FD处理都慢慢来</div><div class="line"> * 		3. 内核/用户空间内存拷贝问题，内核把FD消息通知给用户空间采取了内存拷贝方法</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/select.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 使用select的需要维护client数组和allset的描述符集</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> sockaddr_in cliaddr, servaddr;</div><div class="line"></div><div class="line">    <span class="comment">// socket</span></div><div class="line">    <span class="keyword">int</span> listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"socket error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish socket...\n"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// bind</span></div><div class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">    servaddr.sin_family = AF_INET;</div><div class="line">    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">    servaddr.sin_port = htons(SERV_PORT);</div><div class="line">    <span class="keyword">if</span> (bind(listenfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish bind...\n"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// listen</span></div><div class="line">    <span class="comment">// 套接字排队的最大连接数为20</span></div><div class="line">    <span class="keyword">if</span> (listen(listenfd, <span class="number">20</span>) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"listen error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish listening...\n"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> maxfd = listenfd;</div><div class="line">    <span class="keyword">int</span> maxi = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">int</span> client[FD_SETSIZE];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;FD_SETSIZE; i++)</div><div class="line">    &#123;</div><div class="line">    	client[i] = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line">    fd_set allset;</div><div class="line">    FD_ZERO(&amp;allset);</div><div class="line">    FD_SET(listenfd, &amp;allset);</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( ; ; )</div><div class="line">    &#123;</div><div class="line">    	fd_set rset = allset;</div><div class="line">    	<span class="keyword">int</span> nready = select(maxfd + <span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">    	<span class="keyword">if</span> (FD_ISSET(listenfd, &amp;rset))</div><div class="line">    	&#123;</div><div class="line">    		<span class="comment">// 设置client数组</span></div><div class="line">    		<span class="keyword">socklen_t</span> clilen = <span class="keyword">sizeof</span>(cliaddr);</div><div class="line">    		<span class="comment">// 调用select时有个问题，见书中16.6节</span></div><div class="line">    		<span class="comment">// 如果调用accept时客户端已经关闭连接，此时accept会阻塞并直到新的客户端连接到来</span></div><div class="line">    		<span class="comment">// 为了解决该问题可以将套接字设置为非阻塞再调用accept</span></div><div class="line">			<span class="keyword">int</span> connfd = accept(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, &amp;clilen);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"accept one client:%d...\n"</span>, connfd);</div><div class="line">			<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">			<span class="keyword">for</span> (; i&lt;FD_SETSIZE; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (client[i] &lt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">					client[i] = connfd;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			FD_SET(connfd, &amp;allset);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (i == FD_SETSIZE)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"too many clients"</span>);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (connfd &gt; maxfd)</div><div class="line">			&#123;</div><div class="line">				maxfd = connfd;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (i &gt; maxi)</div><div class="line">			&#123;</div><div class="line">				maxi = i;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="comment">// 检测所有客户端的数据</span></div><div class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=maxi; i++)</div><div class="line">    	&#123;</div><div class="line">    		<span class="keyword">if</span> (client[i] &lt; <span class="number">0</span>)</div><div class="line">    		&#123;</div><div class="line">    			<span class="keyword">continue</span>;</div><div class="line">    		&#125;</div><div class="line">    		<span class="keyword">if</span> (FD_ISSET(client[i], &amp;rset))</div><div class="line">    		&#123;</div><div class="line">    			<span class="keyword">int</span> n;</div><div class="line">    			<span class="keyword">char</span> buf[MAXLINE];</div><div class="line">    			<span class="built_in">printf</span>(<span class="string">"start reading form one client...\n"</span>);</div><div class="line">    			<span class="keyword">if</span> ((n = read(client[i], buf, MAXLINE)) == <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">    				close(client[i]);</div><div class="line">    				FD_CLR(client[i], &amp;allset);</div><div class="line">    				client[i] = <span class="number">-1</span>;</div><div class="line">				&#125;</div><div class="line">    			<span class="keyword">else</span></div><div class="line">    			&#123;</div><div class="line">    				write(client[i], buf, n);</div><div class="line">    			&#125;</div><div class="line">    			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</div><div class="line">    			&#123;</div><div class="line">    				<span class="keyword">break</span>;</div><div class="line">    			&#125;</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="poll版本"><a href="#poll版本" class="headerlink" title="poll版本"></a>poll版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * poll版本</div><div class="line"> * poll版本的解决了select文件描述符限制问题，但是仍然具备select的缺点中的2和3</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stropts.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> OPEN_MAX 1024  <span class="comment">// 该宏已经从limit.h中移除，用来表示一个进程可以打开的最大描述符数目</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 使用select的缺点为需要维护client数组</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> sockaddr_in cliaddr, servaddr;</div><div class="line"></div><div class="line">    <span class="comment">// socket</span></div><div class="line">    <span class="keyword">int</span> listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"socket error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish socket...\n"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// bind</span></div><div class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">    servaddr.sin_family = AF_INET;</div><div class="line">    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">    servaddr.sin_port = htons(SERV_PORT);</div><div class="line">    <span class="keyword">if</span> (bind(listenfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish bind...\n"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// listen</span></div><div class="line">    <span class="comment">// 套接字排队的最大连接数为20</span></div><div class="line">    <span class="keyword">if</span> (listen(listenfd, <span class="number">20</span>) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"listen error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"finish listening...\n"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">struct</span> pollfd client[OPEN_MAX];</div><div class="line">    client[<span class="number">0</span>].fd = listenfd;</div><div class="line">    client[<span class="number">0</span>].events = POLLIN;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;OPEN_MAX; i++)</div><div class="line">    &#123;</div><div class="line">    	client[i].fd = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> maxi = <span class="number">0</span>;	<span class="comment">// 当前client正在使用的最大下标</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( ; ; )</div><div class="line">    &#123;</div><div class="line">    	<span class="keyword">int</span> nready = poll(client, maxi + <span class="number">1</span>, <span class="number">-1</span>);</div><div class="line">    	<span class="keyword">if</span> (client[<span class="number">0</span>].revents &amp; POLLIN)</div><div class="line">    	&#123;</div><div class="line">    		<span class="comment">// 设置client数组</span></div><div class="line">    		<span class="keyword">socklen_t</span> clilen = <span class="keyword">sizeof</span>(cliaddr);</div><div class="line">			<span class="keyword">int</span> connfd = accept(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, &amp;clilen);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"accept one client:%d...\n"</span>, connfd);</div><div class="line">			<span class="keyword">int</span> i = <span class="number">1</span>;</div><div class="line">			<span class="keyword">for</span> (; i&lt;OPEN_MAX; i++)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">if</span> (client[i].fd &lt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">					client[i].fd = connfd;</div><div class="line">					<span class="keyword">break</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (i == OPEN_MAX)</div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"too many clients"</span>);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">			&#125;</div><div class="line">			client[i].events = POLLIN;</div><div class="line">			<span class="keyword">if</span> (i &gt; maxi)</div><div class="line">			&#123;</div><div class="line">				maxi = i;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">    	&#125;</div><div class="line"></div><div class="line">    	<span class="comment">// 检测所有客户端的数据</span></div><div class="line">    	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=maxi; i++)</div><div class="line">    	&#123;</div><div class="line">    		<span class="keyword">if</span> (client[i].fd &lt; <span class="number">0</span>)</div><div class="line">    		&#123;</div><div class="line">    			<span class="keyword">continue</span>;</div><div class="line">    		&#125;</div><div class="line">    		<span class="keyword">if</span> (client[i].revents &amp; (POLLIN | POLLERR))</div><div class="line">    		&#123;</div><div class="line">    			<span class="keyword">int</span> n;</div><div class="line">    			<span class="keyword">char</span> buf[MAXLINE];</div><div class="line">    			<span class="built_in">printf</span>(<span class="string">"start reading form one client...\n"</span>);</div><div class="line">    			<span class="keyword">if</span> ((n = read(client[i].fd, buf, MAXLINE)) &lt; <span class="number">0</span>)</div><div class="line">				&#123;</div><div class="line">    				<span class="keyword">if</span> (errno == ECONNRESET)</div><div class="line">    				&#123;</div><div class="line">    					close(client[i].fd);</div><div class="line">    					client[i].fd = <span class="number">-1</span>;</div><div class="line">    				&#125;</div><div class="line">    				<span class="keyword">else</span></div><div class="line">    				&#123;</div><div class="line">    					<span class="built_in">printf</span>(<span class="string">"read client error\n"</span>);</div><div class="line">    					<span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">    				&#125;</div><div class="line">				&#125;</div><div class="line">    			<span class="keyword">else</span> <span class="keyword">if</span> (n == <span class="number">0</span>)</div><div class="line">    			&#123;</div><div class="line">    				<span class="built_in">printf</span>(<span class="string">"client %d close\n"</span>, client[i].fd);</div><div class="line">    				close(client[i].fd);</div><div class="line">    				client[i].fd = <span class="number">-1</span>;</div><div class="line">    			&#125;</div><div class="line">    			<span class="keyword">else</span></div><div class="line">    			&#123;</div><div class="line">    				write(client[i].fd, buf, n);</div><div class="line">    			&#125;</div><div class="line">    			<span class="keyword">if</span> (--nready &lt;= <span class="number">0</span>)</div><div class="line">    			&#123;</div><div class="line">    				<span class="keyword">break</span>;</div><div class="line">    			&#125;</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="多线程版本"><a href="#多线程版本" class="headerlink" title="多线程版本"></a>多线程版本</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 多线程版本</div><div class="line"> * TPC(Thread Per Connection)模型</div><div class="line"> * 线程的开销虽然比进程小，但是仍然有比较大开销，因此并发数不是很高</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">str_echo</span><span class="params">(<span class="keyword">int</span> sockfd)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">ssize_t</span>	n;</div><div class="line">	<span class="keyword">char</span> buf[MAXLINE];</div><div class="line"></div><div class="line">again:</div><div class="line">	<span class="keyword">while</span> ( (n = read(sockfd, buf, MAXLINE)) &gt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		write(sockfd, buf, n);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (n &lt; <span class="number">0</span> &amp;&amp; errno == EINTR)</div><div class="line">		<span class="keyword">goto</span> again;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"str_echo: read error\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">doit</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></div><div class="line">&#123;</div><div class="line">	pthread_detach(pthread_self());</div><div class="line">	str_echo((<span class="keyword">int</span>)arg);</div><div class="line">	close((<span class="keyword">int</span>)arg);</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"close socket...\n"</span>);</div><div class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> listenfd, connfd;</div><div class="line">    <span class="keyword">struct</span> sockaddr_in cliaddr, servaddr;</div><div class="line"></div><div class="line">    <span class="comment">// socket</span></div><div class="line">    listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (listenfd == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"socket error\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="comment">// bind</span></div><div class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">    servaddr.sin_family = AF_INET;</div><div class="line">    servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">    servaddr.sin_port = htons(SERV_PORT);</div><div class="line">    <span class="keyword">if</span> (bind(listenfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// listen</span></div><div class="line">    <span class="comment">// 套接字排队的最大连接数为20</span></div><div class="line">    <span class="keyword">if</span> (listen(listenfd, <span class="number">20</span>) == <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">    	<span class="built_in">printf</span>(<span class="string">"listen error\n"</span>);</div><div class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> ( ; ; )</div><div class="line">    &#123;</div><div class="line">    	<span class="keyword">socklen_t</span> clilen = <span class="keyword">sizeof</span>(cliaddr);</div><div class="line">    	<span class="comment">// 处理accept被信号中断时返回EINTR错误</span></div><div class="line">		<span class="keyword">if</span> ((connfd = accept(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, &amp;clilen)) &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (errno == EINTR)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">continue</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"accept error"</span>);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"receive new client...\n"</span>);</div><div class="line">		<span class="keyword">pthread_t</span> tid;</div><div class="line">		pthread_create(&amp;tid, <span class="literal">NULL</span>, &amp;doit, (<span class="keyword">void</span> *)connfd);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h1><p>由于udp比较简单，书中并未将udp协议当做重点来讲解。</p>
<h2 id="UDP客户端程序"><a href="#UDP客户端程序" class="headerlink" title="UDP客户端程序"></a>UDP客户端程序</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="comment">// sendto、recvfrom方式</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dg_cli</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *pservaddr, <span class="keyword">socklen_t</span> servlen)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> sendline[MAXLINE], recvline[MAXLINE + <span class="number">1</span>];</div><div class="line">	<span class="keyword">struct</span> sockaddr *preply_addr = (<span class="keyword">struct</span> sockaddr *)<span class="built_in">malloc</span>(servlen);</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (fgets(sendline, MAXLINE, fp) != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		sendto(sockfd, sendline, <span class="built_in">strlen</span>(sendline), <span class="number">0</span>, pservaddr, servlen);</div><div class="line">		<span class="keyword">int</span> len = servlen;</div><div class="line">		<span class="keyword">int</span> n = recvfrom(sockfd, recvline, MAXLINE, <span class="number">0</span>, preply_addr, &amp;len);</div><div class="line">		<span class="comment">// 为了防止接收到其他进程的数据，通过条件判断去除</span></div><div class="line">		<span class="keyword">if</span> (len != servlen || <span class="built_in">memcmp</span>(pservaddr, preply_addr, len) != <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"reply from others (!ignore)\n"</span>);</div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		&#125;</div><div class="line">		recvline[n] = <span class="number">0</span>;</div><div class="line">		<span class="built_in">fputs</span>(recvline, <span class="built_in">stdout</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// connect、write、read方式</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dg_cli2</span><span class="params">(FILE *fp, <span class="keyword">int</span> sockfd, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *pservaddr, <span class="keyword">socklen_t</span> servlen)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> sendline[MAXLINE], recvline[MAXLINE + <span class="number">1</span>];</div><div class="line"></div><div class="line">	connect(sockfd, (<span class="keyword">struct</span> sockaddr *)pservaddr, servlen);</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (fgets(sendline, MAXLINE, fp) != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		write(sockfd, sendline, <span class="built_in">strlen</span>(sendline));</div><div class="line">		<span class="keyword">int</span> n = read(sockfd, recvline, MAXLINE);</div><div class="line">		recvline[n] = <span class="number">0</span>;</div><div class="line">		<span class="built_in">fputs</span>(recvline, <span class="built_in">stdout</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"usage: tcpcli &lt;IPaddress&gt;\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> sockaddr_in servaddr;</div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	inet_pton(AF_INET, argv[<span class="number">1</span>], &amp;servaddr.sin_addr);</div><div class="line"></div><div class="line">	<span class="keyword">int</span> sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	dg_cli2(<span class="built_in">stdin</span>, sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	<span class="built_in">exit</span>(<span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="UDP服务端程序"><a href="#UDP服务端程序" class="headerlink" title="UDP服务端程序"></a>UDP服务端程序</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dg_echo</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">struct</span> sockaddr *pcliaddr, <span class="keyword">socklen_t</span> clilen)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">char</span> mesg[MAXLINE];</div><div class="line">	<span class="keyword">for</span> (;;)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">socklen_t</span> len = clilen;</div><div class="line">		<span class="keyword">int</span> n;</div><div class="line">		bzero(mesg, MAXLINE);</div><div class="line">		<span class="keyword">if</span> ((n = recvfrom(sockfd, mesg, MAXLINE, <span class="number">0</span>,  pcliaddr, &amp;len)) &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			close(sockfd);</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"recvfrom error, error=%m\n"</span>);</div><div class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"recv %s\n"</span>, mesg);</div><div class="line">		sendto(sockfd, mesg, n, <span class="number">0</span>, pcliaddr, len);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	<span class="keyword">struct</span> sockaddr_in servaddr, cliaddr;</div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	<span class="keyword">if</span> (bind(sockfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dg_echo(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, <span class="keyword">sizeof</span>(cliaddr));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="UDP服务端信号驱动式I-O版本"><a href="#UDP服务端信号驱动式I-O版本" class="headerlink" title="UDP服务端信号驱动式I/O版本"></a>UDP服务端信号驱动式I/O版本</h2><p>信号驱动式I/O：进程执行I/O系统调用告知内核启动某个I/O操作，内核启动I/O操作后立即返回到进程。进程在I/O操作发生期间继续执行。当操作完成或遇到错误时，内核以进程在I/O系统调用中指定的方式通知进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 信号驱动式I/O在TCP套接字用途不大，该信号产生的过于频繁，它的出现并未指示发生的事情</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;strings.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SERV_PORT 9877</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXLINE		4096	<span class="comment">/* max text line length */</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> sockfd;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXDG 4096</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">void</span> *dg_data;				<span class="comment">// 实际数据</span></div><div class="line">	<span class="keyword">size_t</span> dg_len;				<span class="comment">// 实际数据长度</span></div><div class="line">	<span class="keyword">struct</span> sockaddr *dg_sa;		<span class="comment">// 包含客户端地址</span></div><div class="line">	<span class="keyword">socklen_t</span> dg_salen;			<span class="comment">// 客户端地址长度</span></div><div class="line">&#125; DG;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> QSIZE 8</span></div><div class="line"><span class="keyword">static</span> DG dg[QSIZE];			<span class="comment">// 存放数据的环形缓冲区</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">long</span> cntread[QSIZE + <span class="number">1</span>];</div><div class="line"><span class="comment">// 需要处理的下一个数据元素的下标</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> iget;</div><div class="line"><span class="comment">// 存放数据元素的下一个位置</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> iput;</div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> nqueue;				<span class="comment">// 队列中的数据个数</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">socklen_t</span> clilen;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sig_hup</span><span class="params">(<span class="keyword">int</span> signo)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (; i &lt;= QSIZE; i++)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"cntread[%d = %ld\n"</span>, i, cntread[i]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sig_io</span><span class="params">(<span class="keyword">int</span> signo)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> nread;</div><div class="line">	<span class="comment">// 为了解决非实时信号不排队问题，采用循环读取方式</span></div><div class="line">	<span class="keyword">for</span> (nread = <span class="number">0</span>; ; )</div><div class="line">	&#123;</div><div class="line">		<span class="comment">// 检查队列是否已满</span></div><div class="line">		<span class="keyword">if</span> (nread &gt;= QSIZE)</div><div class="line">		&#123;</div><div class="line">			<span class="built_in">printf</span>(<span class="string">"receive overflow\n"</span>);</div><div class="line">			<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		DG *ptr = &amp;dg[iput];</div><div class="line">		ptr-&gt;dg_salen = clilen;</div><div class="line">		<span class="keyword">ssize_t</span> len = recvfrom(sockfd, ptr-&gt;dg_data, MAXDG, <span class="number">0</span>, ptr-&gt;dg_sa, &amp;ptr-&gt;dg_salen);</div><div class="line">		<span class="keyword">if</span> (len &lt; <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (errno == EWOULDBLOCK)</div><div class="line">			&#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"recvfrom error\n"</span>);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		ptr-&gt;dg_len = len;</div><div class="line">		nread++;</div><div class="line">		nqueue++;</div><div class="line">		<span class="keyword">if</span> (++iput &gt;= QSIZE)</div><div class="line">		&#123;</div><div class="line">			iput = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	cntread[nread]++;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dg_echo</span><span class="params">(<span class="keyword">int</span> sockfd_arg, <span class="keyword">struct</span> sockaddr *pcliaddr, <span class="keyword">socklen_t</span> clilen_arg)</span></span></div><div class="line">&#123;</div><div class="line">	sockfd = sockfd_arg;</div><div class="line">	clilen = clilen_arg;</div><div class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (; i&lt;QSIZE; i++)</div><div class="line">	&#123;</div><div class="line">		dg[i].dg_data = <span class="built_in">malloc</span>(MAXDG);</div><div class="line">		dg[i].dg_sa = (<span class="keyword">struct</span> sockaddr *)<span class="built_in">malloc</span>(clilen);</div><div class="line">		dg[i].dg_salen = clilen;</div><div class="line">	&#125;</div><div class="line">	iget = iput = nqueue = <span class="number">0</span>;</div><div class="line">	signal(SIGHUP, sig_hup);</div><div class="line"></div><div class="line">	<span class="comment">// 在启动信号I/O前设置信号处理函数</span></div><div class="line">	signal(SIGIO, sig_io);</div><div class="line"></div><div class="line">	<span class="comment">// 设置接收信号通知的进程，让本进程接收SIGIO信号</span></div><div class="line">	fcntl(sockfd, F_SETOWN, getpid());</div><div class="line"></div><div class="line">	<span class="comment">// 为了能够在得到I/O事件后重复执行I/O操作，需要将文件描述符设置为非阻塞方式</span></div><div class="line">	<span class="comment">// O_ASYNC表示在文件描述符上使用信号驱动I/O</span></div><div class="line">	<span class="keyword">int</span> flags = fcntl(sockfd, F_GETFL);</div><div class="line">	fcntl(sockfd, F_SETFL, flags | O_ASYNC | O_NONBLOCK);</div><div class="line"></div><div class="line">	<span class="keyword">sigset_t</span> zeromask, newmask, oldmask;</div><div class="line">	sigemptyset(&amp;zeromask);</div><div class="line">	sigemptyset(&amp;newmask);</div><div class="line">	sigemptyset(&amp;oldmask);</div><div class="line"></div><div class="line">	<span class="comment">// 设置新的信号掩码，阻塞SIGIO信号</span></div><div class="line">	sigaddset(&amp;newmask, SIGIO);</div><div class="line">	sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask);</div><div class="line">	<span class="keyword">for</span> (; ;)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">while</span> (nqueue == <span class="number">0</span>)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">// 挂起进程直到收到任何信号，该函数返回后SIGIO继续被阻塞</span></div><div class="line">			sigsuspend(&amp;zeromask);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 解除SIGIO的阻塞</span></div><div class="line">		sigprocmask(SIG_SETMASK, &amp;oldmask, <span class="literal">NULL</span>);</div><div class="line">		sendto(sockfd, dg[iget].dg_data, dg[iget].dg_len, <span class="number">0</span>, dg[iget].dg_sa, dg[iget].dg_salen);</div><div class="line">		<span class="keyword">if</span> (++iget &gt;= QSIZE)</div><div class="line">		&#123;</div><div class="line">			iget = <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 为了能够修改nqueue的值，阻塞SIGIO信号</span></div><div class="line">		sigprocmask(SIG_BLOCK, &amp;newmask, &amp;oldmask);</div><div class="line">		nqueue--;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">int</span> sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);</div><div class="line">	<span class="keyword">struct</span> sockaddr_in servaddr, cliaddr;</div><div class="line">	bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</div><div class="line">	servaddr.sin_family = AF_INET;</div><div class="line">	servaddr.sin_addr.s_addr = htonl(INADDR_ANY);</div><div class="line">	servaddr.sin_port = htons(SERV_PORT);</div><div class="line">	<span class="keyword">if</span> (bind(sockfd,  (<span class="keyword">struct</span> sockaddr*)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">printf</span>(<span class="string">"bind error\n"</span>);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	dg_echo(sockfd, (<span class="keyword">struct</span> sockaddr*)&amp;cliaddr, <span class="keyword">sizeof</span>(cliaddr));</div><div class="line">	<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="相关下载"><a href="#相关下载" class="headerlink" title="相关下载"></a>相关下载</h1><p>本文中的实例，代码采用eclipse CDT编写，可以直接导入eclipse中运行。</p>
<p><a href="http://pan.baidu.com/s/1o6zCNOm" target="_blank" rel="external">下载实例</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/linux_funtion_advance_feature/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/linux_funtion_advance_feature/" itemprop="url">
                  Linux函数高级特性
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-22T00:00:00+08:00">
                2014-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近在看《Linux/Unix系统编程手册》一书，这里对书中提到的函数类型进行总结。</p>
<h1 id="可重入"><a href="#可重入" class="headerlink" title="可重入"></a>可重入</h1><p>POSIX标准中的解释如下：</p>
<blockquote>
<p>Reentrant Function:<br>A function whose effect, when called by two or more threads,is guaranteed to be as if the threads each executed thefunction one after another in an undefined order, even ifthe actual execution is interleaved.</p>
</blockquote>
<p>可重入函数跟信号相关，一种更容易理解的解释为：</p>
<p>程序执行到某个函数foo()时，收到信号，于是暂停目前正在执行的函数，转到信号处理函数，而这个信号处理函数的执行过程中，又恰恰也会进入到刚刚执行的函数foo()，便发生了所谓的重入。此时如果foo()能够正确的运行，而且处理完成后，之前暂停的foo()也能够正确运行，则说明它是可重入的。</p>
<p>可重入函数需要满足如下几个条件：</p>
<ul>
<li>不在函数内部使用静态或全局数据</li>
<li>不返回静态或全局数据，所有数据均有函数调用者提供</li>
<li>使用本地数据或通过复制全局数据来保护全局数据</li>
<li>不调用不可重入函数</li>
</ul>
<h1 id="标准的异步安全信号函数"><a href="#标准的异步安全信号函数" class="headerlink" title="标准的异步安全信号函数"></a>标准的异步安全信号函数</h1><p>异步信号安全的函数指当从信号处理函数调用时，可保证实现是安全的。如果某一个函数是可重入的，或者信号处理函数无法将其中断时，称该函数是异步信号安全的。</p>
<p>我的理解是可重入函数和标准的异步安全信号函数基本等同，只是描述层面不同。</p>
<h1 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h1><p>若函数可同时供多个线程安全的调用，则该函数为线程安全的函数。比较容易理解。</p>
<h1 id="线程安全与可重入之间的关系"><a href="#线程安全与可重入之间的关系" class="headerlink" title="线程安全与可重入之间的关系"></a>线程安全与可重入之间的关系</h1><p>可重入函数一定为线程安全的函数。线程安全函数不一定是可重入函数。</p>
<p>不可重入函数，函数调用结果不具有可再现性，可通过互斥锁等机制供多个线程安全的调用，这样该不可重入函数即为线程安全的函数。</p>
<p>malloc函数内部维护了全局数据结构，因此为不可重入的，但是内部通过递归互斥量来确保为线程安全的函数。并且该互斥量必须是可递归的，否则当malloc函数重入的情况下，会造成死锁。在glibc中，malloc有线程安全和非线程安全两个版本，两个区别在于内部是否使用递归锁，当编译程序时使用了<code>_pthreads</code>选项时使用线程安全版本，否则使用非线程安全版本。</p>
<h1 id="自动重启"><a href="#自动重启" class="headerlink" title="自动重启"></a>自动重启</h1><p>Linux中的某些系统调用在阻塞的过程中，如果接受到信号并转去处理信号处理函数，当从信号处理函数返回时这些阻塞的系统调用默认会返回EINTR。为了避免信号处理函数对阻塞中的系统调用的打断，可以通过设置SA_RESTART标志的sigaction()来建立信号处理函数，从而令内核代表进程自动重启系统调用，而无需处理系统调用返回的EINTR错误。</p>
<p>并非所有的系统调用都支持自动重启，具体可参考《Linux/Unix系统编程手册（上册）》的21.5节。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>《Linux/Unix系统编程手册（上册）》</p>
<p><a href="http://blog.csdn.net/lovekatherine/article/details/1544644" target="_blank" rel="external">对可重性和线程安全的小结</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/python_parse_web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/python_parse_web/" itemprop="url">
                  通过python来抓取和解析网页内容
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-14T00:00:00+08:00">
                2014-12-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近这段时间回顾了下python，距离上次使用python已经超过两年的时间了。</p>
<p>相对于c++语言，python要灵活许多，对于工作中的一些小问题的解决可以通过python来实现比较高效和方便，比如网页的抓取和解析。甚至对于非IT的工作，也可以通过脚本的方式来解决，只要是工作中遇到反复处理的体力活劳动就可以考虑利用编程方式来解决。</p>
<p>本文以我的博客的<a href="http://kuring.me/archive">文档列表页面</a>为例，利用python对页面中的文章名进行提取。</p>
<p>文章列表页中的文章列表部分的url如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"listing-item"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span>2014-12-03<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/post/linux_funtion_advance_feature"</span>  <span class="attr">title</span>=<span class="string">"Linux函数高级特性"</span> &gt;</span>Linux函数高级特性<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"listing-item"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"date"</span>&gt;</span>2014-12-02<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/post/cgdb"</span>  <span class="attr">title</span>=<span class="string">"cgdb的使用"</span> &gt;</span>cgdb的使用<span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">...</div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure>
<h1 id="requests模块的安装"><a href="#requests模块的安装" class="headerlink" title="requests模块的安装"></a>requests模块的安装</h1><p>requests模块用于加载要请求的web页面。</p>
<p>在python的命令行中输入<code>import requests</code>，报错说明requests模块没有安装。</p>
<p>我这里打算采用easy_install的在线安装方式安装，发现系统中并不存在easy_install命令，输入<code>sudo apt-get install python-setuptools</code>来安装easy_install工具。</p>
<p>执行<code>sudo easy_install requests</code>安装requests模块。</p>
<h1 id="Beautiful-Soup安装"><a href="#Beautiful-Soup安装" class="headerlink" title="Beautiful Soup安装"></a>Beautiful Soup安装</h1><p>为了能够对页面中的内容进行解析，本文使用Beautiful Soup。当然，本文的例子需求较简单，完全可以使用分析字符串的方式。</p>
<p>执行<code>sudo easy_install beautifulsoup4</code>即可安装。</p>
<h1 id="编码问题"><a href="#编码问题" class="headerlink" title="编码问题"></a>编码问题</h1><p>python的编码问题确实是一个很头大的问题，尤其是对于不熟悉python的菜鸟。</p>
<p>python自身的编码问题就已经够头大的了，碰巧requests模块也有一个编码问题的bug，具体的bug见参考文章。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python                                                                                                                                                           </span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="string">' a http parse test programe '</span></div><div class="line"></div><div class="line">__author__ = <span class="string">'kuring lv'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> bs4</div><div class="line"></div><div class="line">archives_url = <span class="string">"http://kuring.me/archive"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_parse</span><span class="params">(url)</span> :</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"开始获取(%s)内容"</span> % url</div><div class="line">    response = requests.get(url)</div><div class="line">    <span class="keyword">print</span> <span class="string">"获取网页内容完毕"</span></div><div class="line">    </div><div class="line">    soup = bs4.BeautifulSoup(response.content.decode(<span class="string">"utf-8"</span>))</div><div class="line">    <span class="comment">#soup = bs4.BeautifulSoup(response.text);</span></div><div class="line">    </div><div class="line">    <span class="comment"># 为了防止漏掉调用close方法，这里使用了with语句</span></div><div class="line">    <span class="comment"># 写入到文件中的编码为utf-8</span></div><div class="line">    <span class="keyword">with</span> open(<span class="string">'archives.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f :</div><div class="line">        <span class="keyword">for</span> archive <span class="keyword">in</span> soup.select(<span class="string">"li.listing-item a"</span>) :</div><div class="line">            f.write(archive.get_text().encode(<span class="string">'utf-8'</span>) + <span class="string">"\n"</span>)</div><div class="line">            <span class="keyword">print</span> archive.get_text().encode(<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line"><span class="comment"># 当命令行运行该模块时，__name__等于'__main__'</span></div><div class="line"><span class="comment"># 其他模块导入该模块时，__name__等于'parse_html'</span></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span> :</div><div class="line">    start_parse(archives_url)</div></pre></td></tr></table></figure>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><p><a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000" target="_blank" rel="external">廖雪峰的python教程</a></p>
</li>
<li><p><a href="http://www.crummy.com/software/BeautifulSoup/bs4/doc/index.zh.html" target="_blank" rel="external">Beautiful Soup 4.2.0 文档</a></p>
</li>
<li><p><a href="http://wuchong.me/blog/2014/04/24/easy-web-scraping-with-python/" target="_blank" rel="external">使用 Python 轻松抓取网页</a></p>
</li>
<li><p><a href="http://www.au92.com/archives/python-requests-chinese-improve-random-code.html" target="_blank" rel="external">Python+Requests抓取中文乱码改进方案</a></p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/programming_pearls_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/programming_pearls_1/" itemprop="url">
                  编程珠玑读书笔记第1章开篇
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-11-23T00:00:00+08:00">
                2014-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>一个最多包含n个正整数的文件，每个数小于n，其中n为10000000。要求升序排列整数列表，最多使用1MB的内存，运行时间尽可能短。</p>
<h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;                                                                                                                                                              </span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BITSPERWORD 32</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> SHIFT 5</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> MASK 0x1F</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N 10000000</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> a[<span class="number">1</span> + N/BITSPERWORD] = &#123;<span class="number">0</span>&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * i&gt;&gt;SHIFT相当于i/32，用于确定i在第几个int数组中</div><div class="line"> * 其中i&amp;MASK含义为i%32，用于确定在int中的第几位</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line">&#123;</div><div class="line">    a[i &gt;&gt; SHIFT] |= (<span class="number">1</span> &lt;&lt; (i &amp; MASK));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">clr</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line">&#123;</div><div class="line">    a[i &gt;&gt; SHIFT] &amp;= (<span class="number">0</span> &lt;&lt; (i &amp; MASK));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> a[i &gt;&gt; SHIFT] &amp; (<span class="number">1</span> &lt;&lt; (i &amp; MASK));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">while</span> (<span class="built_in">scanf</span>(<span class="string">"%d"</span>, &amp;i) != EOF)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">set</span>(i);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (test(i))</div><div class="line">        &#123;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, i);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<h1 id="习题5"><a href="#习题5" class="headerlink" title="习题5"></a>习题5</h1><p>通过shell命令<code>echo &quot;scale=2; 10000000 / 1024 / 8 / 1024.0&quot; | bc</code>计算该程序运行时至少需要的存储空间为1.19MB，如果仅提供了1MB的存储空间，则需要更改上述程序的处理方式。</p>
<p>可采用多趟算法，多趟读入输入数据，每次完成一步。针对该题，可采用2步来完成，int数组的大小变更为5000000/8，比之前小了一半。第一步处理0-4999999之间的数据，第二步处理5000000-999999之间的数据。</p>
<h1 id="习题6"><a href="#习题6" class="headerlink" title="习题6"></a>习题6</h1><p>如果是每个整数至少出现10次，而不是原先的一次。可以使用4bit来统计出现的次数，申请的数组大小变为了10000000/2。只要是每个整数有出现的最多次数上限该种处理方式就合适，当然整数出现的上限不能太大，否则该算法就没有了任何优势。</p>
<h1 id="习题9"><a href="#习题9" class="headerlink" title="习题9"></a>习题9</h1><p>对一个大的数组的初始化操作需要耗费一些时间，为了消除数组的初始化，可以通过两个额外的数组来解决，这是典型的用空间换时间的方法。</p>
<pre style="font-family: Courier, monospace;">
      +---+---+---+---+---+---+---+----+
data  |   |   | 3 |   | 2 |   | 8 |    |
      +---+---+---+---+---+---+---+----+

      +---+---+---+---+---+---+---+----+
from  |   |   | 0 |   | 2 |   | 1 |    |
      +---+---+---+---+---+---+---+----+

      +---+---+---+---+---+---+---+----+
to    | 1 | 5 | 3 |   |   |   |   |    |
      +---+---+---+---+---+---+---+----+

                    ^                   
                    +                   
                   top                  
</pre>

<p>上图中data为要初始化的数组，from和to为辅助数组。如果data[i]已经初始化，则from[i]&lt;top，to[from[i]]=i。from是一个简单的标识，to和top确保了from中不会写入内存中的随机内容。</p>
<h1 id="习题11"><a href="#习题11" class="headerlink" title="习题11"></a>习题11</h1><p>该题的答案太他妈逗了，为了能够解决两地之间的数据传输瓶颈，作者给出的答案居然是用信鸽传输图片的底片后再将底片放大的方式来代替原先的用汽车运输的方式，这就是中国古代的飞鸽传书啊。</p>
<h1 id="习题12"><a href="#习题12" class="headerlink" title="习题12"></a>习题12</h1><p>该题在《三傻大闹宝莱坞》中见过，这跟编程毛线关系也没有啊。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://kuring.me/post/my_makefile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kuring Lyu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一只特立独行的鸟">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/post/my_makefile/" itemprop="url">
                  我的Makefile文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-11-23T00:00:00+08:00">
                2014-11-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近学习了《GNU Make项目管理》，改进了我之前一直在用的Makefile文件，解决我之前的Makefile中一直存在的修改依赖头文件后不能自动编译cpp文件的问题。本文列举了我常用的两个Makefile文件，其中第一个为我常用的Makefile，第二个为从网上找到的其他Makefile文件。</p>
<h1 id="第一个Makefile"><a href="#第一个Makefile" class="headerlink" title="第一个Makefile"></a>第一个Makefile</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="section">all:</span></div><div class="line">INCLUDE = -I./</div><div class="line"></div><div class="line">FLAGS = -g -Wall <span class="variable">$(INCLUDE)</span></div><div class="line">FLAGS += -fPIC</div><div class="line"></div><div class="line">LIBDIR = -lz -lm -lcrypto</div><div class="line"></div><div class="line">LINK = <span class="variable">$(LIBDIR)</span> -lpthread</div><div class="line"></div><div class="line">GCC = g++</div><div class="line"></div><div class="line"><span class="comment"># for C++ language</span></div><div class="line">CODE.cpp = main.cpp \</div><div class="line">			trim.cpp</div><div class="line"></div><div class="line">CPP.o = $(CODE.cpp:.cpp=.o)</div><div class="line">OBJS.d = $(CODE.cpp:.cpp=.d)</div><div class="line"></div><div class="line">OBJS.o = $(CPP.o)</div><div class="line"></div><div class="line"><span class="comment"># 解决头文件依赖</span></div><div class="line">-include $(subst .cpp,.d,$(CODE.cpp))</div><div class="line"></div><div class="line">%.d: %.cpp</div><div class="line">	<span class="variable">$(GCC)</span> -M <span class="variable">$(FLAGS)</span> $&lt; &gt; $@.$$$$;		\</div><div class="line">	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' &lt; $@.$$$$ &gt; $@;	\</div><div class="line">	rm -f $@.$$$$</div><div class="line"></div><div class="line"><span class="comment"># rule for C++ language</span></div><div class="line">%.o : %.cpp	</div><div class="line">	<span class="variable">$(GCC)</span> <span class="variable">$(FLAGS)</span> -o $@ -c $&lt;	</div><div class="line">	@echo $*.o build successfully!......</div><div class="line"></div><div class="line">TARGET = main</div><div class="line">	</div><div class="line">$(TARGET) : $(OBJS.o) </div><div class="line">	<span class="variable">$(GCC)</span> <span class="variable">$(OBJS.o)</span> -o <span class="variable">$(TARGET)</span> <span class="variable">$(LINK)</span></div><div class="line">	@echo <span class="variable">$(TARGET)</span> BUILD OK!.........</div><div class="line"></div><div class="line">all : $(TARGET)</div><div class="line"></div><div class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>:</span></div><div class="line"><span class="section">clean:</span></div><div class="line">	rm -rf <span class="variable">$(TARGET)</span></div><div class="line">	rm -rf <span class="variable">$(OBJS.o)</span></div><div class="line">	rm -rf <span class="variable">$(OBJS.d)</span></div><div class="line">	rm -rf *.d</div></pre></td></tr></table></figure>
<p>该文件特点为需要手工将需要编译的源文件手动添加到Makefile中，可能比较麻烦，但是编译时比较灵活。可以随意修改需要编译源文件的顺序和是否需要编译源文件。</p>
<h1 id="第二个Makefile"><a href="#第二个Makefile" class="headerlink" title="第二个Makefile"></a>第二个Makefile</h1><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">###########################################################</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># KEFILE FOR C/C++ PROJECT</span></div><div class="line"><span class="comment"># Author: swm8023 &lt;swm8023@gmail.com&gt;</span></div><div class="line"><span class="comment"># Date:   2014/01/30</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">###########################################################</span></div><div class="line"></div><div class="line"><span class="meta"><span class="meta-keyword">.PHONY</span>: all clean</span></div><div class="line"><span class="section">all: </span></div><div class="line"></div><div class="line"><span class="comment"># annotation when release version</span></div><div class="line">DEBUG       := y</div><div class="line">TARGET_PROG := main</div><div class="line"></div><div class="line"><span class="comment"># project directory	</span></div><div class="line">DEBUG_DIR   := ./Debug</div><div class="line">RELEASE_DIR := ./Release</div><div class="line">BIN_DIR     := <span class="variable">$(if $(DEBUG)</span>, <span class="variable">$(DEBUG_DIR)</span>, <span class="variable">$(RELEASE_DIR)</span>)</div><div class="line"></div><div class="line"><span class="comment"># shell command</span></div><div class="line">CC    := gcc</div><div class="line">CXX   := g++</div><div class="line">RM    := rm -rf</div><div class="line">MKDIR := mkdir -p</div><div class="line">SED   := sed</div><div class="line">MV    := mv</div><div class="line"></div><div class="line"><span class="comment"># init sources &amp; objects &amp; depends</span></div><div class="line">sources_all := <span class="variable">$(shell find . -name "*.c" -o -name "*.cpp" -o -name "*.h")</span></div><div class="line">sources_c   := <span class="variable">$(filter %.c, $(sources_all)</span>)</div><div class="line">sources_cpp := <span class="variable">$(filter %.cpp, $(sources_all)</span>)</div><div class="line">sources_h   := <span class="variable">$(filter %.h, $(sources_all)</span>)</div><div class="line">objs        := <span class="variable">$(addprefix $(BIN_DIR)</span>/,<span class="variable">$(strip $(sources_cpp:.cpp=.o)</span> <span class="variable">$(sources_c:.c=.o)</span>))</div><div class="line">deps        := <span class="variable">$(addprefix $(BIN_DIR)</span>/,<span class="variable">$(strip $(sources_cpp:.cpp=.d)</span> <span class="variable">$(sources_c:.c=.d)</span>))</div><div class="line"></div><div class="line"><span class="comment"># create directory</span></div><div class="line">$(foreach dirname,$(sort $(dir $(sources_c) $(sources_cpp))),\</div><div class="line">  $(shell $(MKDIR) $(BIN_DIR)/$(dirname)))</div><div class="line"></div><div class="line"><span class="comment"># complie &amp; link variable</span></div><div class="line">CFLAGS     := <span class="variable">$(if $(DEBUG)</span>,-g -O, -O2)</div><div class="line">CFLAGS     += <span class="variable">$(addprefix -I ,$(sort $(dir $(sources_h)</span>)))</div><div class="line">CXXFLAGS    = <span class="variable">$(CFLAGS)</span></div><div class="line">LDFLAGS    := </div><div class="line">LOADLIBES  += #-L/usr/include/mysql</div><div class="line">LDLIBS     += #-lpthread -lmysqlclient</div><div class="line"></div><div class="line"><span class="comment"># add vpath</span></div><div class="line">vpath %.h $(sort $(dir $(sources_h)))</div><div class="line">vpath %.c $(sort $(dir $(sources_c)))</div><div class="line">vpath %.cpp $(sort $(dir $(sources_cpp)))</div><div class="line"></div><div class="line"><span class="comment"># generate depend files</span></div><div class="line"><span class="comment"># actually generate after object generated, beacasue it only used when next make)</span></div><div class="line">ifneq "$(MAKECMDGOALS)" "clean"</div><div class="line">sinclude $(deps)</div><div class="line">endif</div><div class="line"></div><div class="line"><span class="comment"># make-depend(depend-file,source-file,object-file,cc)</span></div><div class="line">define make-depend</div><div class="line">  $(RM) $1;                                     \</div><div class="line">  $4 $(CFLAGS) -MM $2 |                         \</div><div class="line">  $(SED) 's,\($(notdir $3)\): ,$3: ,' &gt; $1.tmp; \</div><div class="line">  $(SED) -e 's/<span class="comment">#.*//'                           \</span></div><div class="line">         -e 's/^[^:]*: *//'                     \</div><div class="line">         -e 's/ *\\$$//'                        \</div><div class="line">         -e '/^$$/ d'                           \</div><div class="line">         -e 's/$$/ :/' &lt; $1.tmp &gt;&gt; $1.tmp;      \</div><div class="line">  $(MV) $1.tmp $1;</div><div class="line">endef</div><div class="line"></div><div class="line"><span class="comment"># rules to generate objects file</span></div><div class="line">$(BIN_DIR)/%.o: %.c</div><div class="line">	@<span class="variable">$(call make-depend,$(patsubst %.o,%.d,$@)</span>,$&lt;,$@,<span class="variable">$(CC)</span>)</div><div class="line">	<span class="variable">$(CC)</span> <span class="variable">$(CFLAGS)</span> -o $@ -c $&lt;</div><div class="line"></div><div class="line">$(BIN_DIR)/%.o: %.cpp</div><div class="line">	@<span class="variable">$(call make-depend,$(patsubst %.o,%.d,$@)</span>,$&lt;,$@,<span class="variable">$(CXX)</span>)</div><div class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CXXFLAGS)</span> -o $@ -c $&lt;</div><div class="line"></div><div class="line"><span class="comment"># add-target(target,objs,cc)</span></div><div class="line">define add-target</div><div class="line">  REAL_TARGET += $(BIN_DIR)/$1</div><div class="line">  $(BIN_DIR)/$1: $2</div><div class="line">	$3 <span class="variable">$(LDFLAGS)</span> $$^ <span class="variable">$(LOADLIBES)</span> <span class="variable">$(LDLIBS)</span> -o $$@</div><div class="line">endef</div><div class="line"></div><div class="line"><span class="comment"># call add-target</span></div><div class="line">$(foreach targ,$(TARGET_PROG),$(eval $(call add-target,$(targ),$(objs),$(CXX))))</div><div class="line"></div><div class="line">all: $(REAL_TARGET) $(TARGET_LIBS)</div><div class="line"></div><div class="line"><span class="section">clean: </span></div><div class="line">	<span class="variable">$(RM)</span> <span class="variable">$(BIN_DIR)</span></div></pre></td></tr></table></figure>
<p>该Makefile为从<a href="http://c4fun.cn/blog/2014/01/30/common-makefile/" target="_blank" rel="external">一个通用的C/C++ Makefile</a>中直接获得的，为了避免原博客以后不能访问的情况，这里备份一下。</p>
<p>该Makefile可以动检测Makefile所在目录及其子目录中的.c和.cpp文件，并进行编译，不需要手动修改Makefile来填写需要编译的源文件，比较自动化。</p>
<h1 id="相关参考"><a href="#相关参考" class="headerlink" title="相关参考"></a>相关参考</h1><p>第二个Makefile文件的作者博客中的两篇文章：<a href="http://c4fun.cn/blog/2014/01/13/gnu-make-study01/" target="_blank" rel="external">GNU Make学习总结（一）</a>和<a href="http://c4fun.cn/blog/2014/01/13/gnu-make-study02/" target="_blank" rel="external">GNU Make学习总结（二）</a></p>
<h1 id="相关下载"><a href="#相关下载" class="headerlink" title="相关下载"></a>相关下载</h1><p><a href="http://pan.baidu.com/s/1jGDo5ls" target="_blank" rel="external">一个包含上述两个Makefile的例子</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kuring Lyu" />
          <p class="site-author-name" itemprop="name">Kuring Lyu</p>
           
              <p class="site-description motion-element" itemprop="description">一只特立独行的鸟</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">106</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/kuring" title="Github地址" target="_blank">Github地址</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://weibo.com/ilvkai" title="新浪微博" target="_blank">新浪微博</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kuring Lyu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  





  





  






  





  

  

  

  

</body>
</html>
